<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qube-Inventory Delivery Statistics</title>
    <link rel="icon" href="favicon.ico" type="image/png">
    <style>
:root{
    --bg-gradient: linear-gradient(180deg, #f3f4f6 0%, #e5e7eb 100%);
    --surface:#ffffff;
    --surface-2:#f9fafb;
    --accent:#4f46e5;
    --accent-hover:#4338ca;
    --text:#1f2937;
    --text-muted:#4b5563;
    --border:#d1d5db;
    --shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -2px rgba(0,0,0,.1);
    --shadow-lg:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -4px rgba(0,0,0,.1);
    --radius:0.75rem;
    --success:#10b981;
    --warning:#f59e0b;
    --error:#ef4444;
    --same-day:#3b82f6;
}

*{margin:0;padding:0;box-sizing:border-box}

body{
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
    background:var(--bg-gradient);
    color:var(--text);
    min-height:100vh;
    padding:1.5rem;
}

.container{
    max-width:1200px;
    margin:0 auto;
    border-radius:var(--radius);
    overflow:hidden;
    background:var(--surface);
    box-shadow:var(--shadow-lg);
    border:1px solid var(--border);
}

.header{
    background:linear-gradient(135deg, #ffffff, #f9fafb);
    padding:2rem 2.5rem;
    text-align:center;
    border-bottom:1px solid var(--border);
    position:relative;
}

.header-content{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:0.75rem;
}

.header h1{
    font-size:1.75rem;
    font-weight:700;
    letter-spacing:-.5px;
    color:var(--text);
}

.header h1::before{content:"📊";margin-right:8px}

.header p{margin-top:4px;color:var(--text-muted)}

.header-actions {
    margin-top: 1.5rem;
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
}

.nav-pills {
    display: flex;
    gap: 0.5rem;
    background: var(--surface-2);
    padding: 0.5rem;
    border-radius: var(--radius);
    border: 1px solid var(--border);
}

.nav-pill {
    padding: 0.625rem 1.25rem;
    border: 1px solid transparent;
    border-radius: calc(var(--radius) - 0.25rem);
    background: var(--surface);
    color: var(--text);
    font-size: .875rem;
    font-weight: 600;
    cursor: pointer;
    transition: all .2s;
    text-decoration: none;
}

.nav-pill:hover,
.nav-pill.active {
    background: var(--accent);
    border-color: var(--accent);
    color: #fff;
}

/* KPI Cards - Just 2 cards */
.kpi-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    padding: 1.5rem;
}

.kpi-card {
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 2rem 1.25rem;
    text-align: center;
    transition: transform .15s, box-shadow .15s;
}

.kpi-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.kpi-number {
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 4px;
    color: var(--accent);
}

.kpi-label {
    font-size: .75rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: .5px;
}

/* Charts Grid - 2x2 */
.charts-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    padding: 1.5rem;
}

.chart-container {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1.5rem;
    box-shadow: var(--shadow);
    transition: transform .15s, box-shadow .15s;
}

.chart-container:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--border);
}

.chart-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text);
}

.chart-subtitle {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
}

.chart-canvas {
    position: relative;
    height: 300px;
}

/* Customer Performance Table */
.customer-performance {
    margin: 0 1.5rem 1.5rem;
    padding: 1.5rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
}

.customer-performance h3 {
    color: var(--accent);
    margin-bottom: 1rem;
    font-size: 1.125rem;
}

.table-wrapper {
    overflow-x: auto;
    border-radius: var(--radius);
    background: var(--surface);
    border: 1px solid var(--border);
}

table {
    width: 100%;
    border-collapse: collapse;
}

th, td {
    padding: 0.75rem 1rem;
    text-align: left;
    font-size: .875rem;
    vertical-align: middle;
}

th {
    background: var(--surface-2);
    color: var(--text-muted);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: .5px;
    border-bottom: 1px solid var(--border);
}

tr:hover {
    background: var(--surface-2);
}

.status-badge {
    padding: 4px 8px;
    border-radius: 999px;
    font-size: .7rem;
    font-weight: 600;
    letter-spacing: .5px;
    color: #fff;
    display: inline-block;
}

.status-excellent {
    background: var(--success);
}

.status-good {
    background: var(--same-day);
}

.status-needs-improvement {
    background: var(--warning);
}

/* Loading Animation */
.loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 200px;
    font-size: 1.1rem;
    color: var(--text-muted);
}

.loading::before {
    content: '';
    width: 24px;
    height: 24px;
    border: 3px solid var(--border);
    border-top: 3px solid var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 0.75rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.no-data {
    padding: 2.5rem;
    text-align: center;
    color: var(--text-muted);
    font-size: .875rem;
}

/* Status Messages */
.status-message {
    margin: 0 1.5rem 1.5rem;
    padding: 0.875rem 1.125rem;
    border-radius: var(--radius);
    font-size: .875rem;
}

.status-info {
    background: #eef2ff;
    border: 1px solid #c7d2fe;
    color: var(--accent);
}

.status-success {
    background: #d1fae5;
    border: 1px solid #a7f3d0;
    color: var(--success);
}

.status-error {
    background: #fee2e2;
    border: 1px solid #fecaca;
    color: var(--error);
}

.status-warning {
    background: #fef3c7;
    border: 1px solid #fde68a;
    color: var(--warning);
}

/* Responsive Design */
@media (max-width: 1024px) {
    .charts-grid {
        grid-template-columns: 1fr;
    }
    
    .kpi-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    body {
        padding: 0.75rem;
    }
    
    .header {
        padding: 1.5rem;
    }
    
    .nav-pills {
        flex-direction: column;
    }
    
    .chart-container {
        padding: 1rem;
    }
    
    .kpi-number {
        font-size: 2.5rem;
    }
    
    .charts-grid {
        padding: 1rem;
    }
    
    .kpi-grid {
        padding: 1rem;
    }
}

/* Animation Classes */
.fade-in {
    animation: fadeIn 0.6s ease-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.slide-up {
    animation: slideUp 0.8s ease-out;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header fade-in">
            <div class="header-content">
                <div>
                    <h1>Delivery Performance Analytics</h1>
                    <p>Key insights into delivery operations and performance metrics</p>
                </div>
            </div>
            
            <div class="header-actions">
                <div class="nav-pills">
                    <a href="#" class="nav-pill active" data-period="7d">Last 7 Days</a>
                    <a href="#" class="nav-pill" data-period="30d">Last 30 Days</a>
                    <a href="#" class="nav-pill" data-period="90d">Last 90 Days</a>
                    <a href="#" class="nav-pill" data-period="1y">Last Year</a>
                    <a href="/aging.html" class="nav-pill">📈 Aging Tracker</a>
                </div>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="statusMessage"></div>

        <!-- KPI Cards - Only 2 -->
        <div class="kpi-grid slide-up">
            <div class="kpi-card">
                <div class="kpi-number" id="totalDeliveries">-</div>
                <div class="kpi-label">Total Deliveries</div>
            </div>
            
            <div class="kpi-card">
                <div class="kpi-number" id="avgDeliveryTime">-</div>
                <div class="kpi-label">Average Delivery Days</div>
            </div>
        </div>

        <!-- Charts Grid - Now Cards with Tables -->
        <div class="charts-grid slide-up">
            <!-- Volume Trends Card -->
            <div class="chart-container">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">Daily Volume (Last 7 Days)</div>
                        <div class="chart-subtitle">Delivery volume by day</div>
                    </div>
                </div>
                <div class="chart-canvas">
                    <div id="volumeTable">
                        <table style="width: 100%; font-size: 0.875rem;">
                            <thead>
                                <tr style="background: var(--surface-2);">
                                    <th style="padding: 0.5rem; text-align: left;">Day</th>
                                    <th style="padding: 0.5rem; text-align: right;">Deliveries</th>
                                    <th style="padding: 0.5rem; text-align: right;">vs Prev Week</th>
                                </tr>
                            </thead>
                            <tbody id="volumeTableBody">
                                <tr><td colspan="3" class="loading">Loading data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Service Types Card -->
            <div class="chart-container">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">Service Types</div>
                        <div class="chart-subtitle">Volume by service category</div>
                    </div>
                </div>
                <div class="chart-canvas">
                    <div id="serviceTable">
                        <table style="width: 100%; font-size: 0.875rem;">
                            <thead>
                                <tr style="background: var(--surface-2);">
                                    <th style="padding: 0.5rem; text-align: left;">Service Type</th>
                                    <th style="padding: 0.5rem; text-align: right;">Count</th>
                                    <th style="padding: 0.5rem; text-align: right;">Percentage</th>
                                </tr>
                            </thead>
                            <tbody id="serviceTableBody">
                                <tr><td colspan="3" class="loading">Loading data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Monthly Performance Card -->
            <div class="chart-container">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">Monthly Performance</div>
                        <div class="chart-subtitle">Current vs previous month</div>
                    </div>
                </div>
                <div class="chart-canvas">
                    <div id="monthlyCard" style="text-align: center; padding: 2rem;">
                        <div style="margin-bottom: 1.5rem;">
                            <div style="font-size: 2.5rem; font-weight: 700; color: var(--accent); margin-bottom: 0.25rem;" id="thisMonthCount">-</div>
                            <div style="font-size: 0.875rem; color: var(--text-muted);">This Month</div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <div style="font-size: 1.25rem; color: var(--text-muted); margin-bottom: 0.25rem;" id="lastMonthCount">-</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">Previous Month</div>
                        </div>
                        <div id="monthlyChange" style="font-size: 0.875rem; font-weight: 600; padding: 0.5rem 1rem; border-radius: 999px; display: inline-block;">
                            Loading...
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Weekly Targets Card -->
            <div class="chart-container">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">Weekly Targets</div>
                        <div class="chart-subtitle">Performance vs targets</div>
                    </div>
                </div>
                <div class="chart-canvas">
                    <div id="targetsTable">
                        <table style="width: 100%; font-size: 0.875rem;">
                            <thead>
                                <tr style="background: var(--surface-2);">
                                    <th style="padding: 0.5rem; text-align: left;">Week</th>
                                    <th style="padding: 0.5rem; text-align: right;">Target</th>
                                    <th style="padding: 0.5rem; text-align: right;">Actual</th>
                                    <th style="padding: 0.5rem; text-align: right;">Status</th>
                                </tr>
                            </thead>
                            <tbody id="targetsTableBody">
                                <tr><td colspan="4" class="loading">Loading data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Customer Performance -->
        <div class="customer-performance slide-up">
            <h3>📋 Top Customer Performance</h3>
            <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.875rem;">Customer delivery statistics and performance metrics</p>
            
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Total Orders</th>
                            <th>On-Time Rate</th>
                            <th>Avg Delivery Time</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="customerTable">
                        <tr><td colspan="5" class="loading">Loading customer data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration - Uses SEPARATE table for complete delivery data
        const SUPABASE_CONFIG = {
            url: 'https://iugwfmnfmulgxvaxjkwv.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1Z3dmbW5mbXVsZ3h2YXhqa3d2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3MTU2MDIsImV4cCI6MjA2ODI5MTYwMn0.pUExanPG_BdTN11gtHg_cOubUkMOEv3n0a1mksLH_ZE',
            tableName: 'delivery_analytics', // MAIN table for complete data
            agingTableName: 'delivery_data'  // Fallback aging tracker table
        };

        // Show status messages
        function showMessage(message, type = 'info', duration = 5000) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, duration);
            }
        }

        // Load data from separate analytics database
        async function loadDataFromSupabase() {
            try {
                console.log('📊 Loading complete analytics data...');
                showMessage('🔄 Loading analytics data...', 'info', 3000);
                
                // Try to load from analytics table first
                let response = await fetch(`${SUPABASE_CONFIG.url}/rest/v1/${SUPABASE_CONFIG.tableName}?select=*&order=created_at.desc`, {
                    headers: {
                        'apikey': SUPABASE_CONFIG.key,
                        'Authorization': `Bearer ${SUPABASE_CONFIG.key}`,
                        'Content-Type': 'application/json'
                    }
                });

                let rawData = [];
                
                if (response.ok) {
                    rawData = await response.json();
                    if (rawData.length > 0) {
                        console.log(`✅ Loaded ${rawData.length} records from analytics database`);
                        showMessage(`✅ Analytics data loaded (${rawData.length} records)`, 'success');
                    } else {
                        throw new Error('Analytics table is empty');
                    }
                } else {
                    throw new Error(`Analytics table error: ${response.status}`);
                }

                // Process the complete data
                const analyticsData = processCompleteAnalyticsData(rawData);
                updateDashboardWithRealData(analyticsData);
                
                return analyticsData;
            } catch (error) {
                console.error('❌ Analytics database error:', error);
                
                // Fallback: try to use aging data but inform user about limitation
                try {
                    console.log('🔄 Falling back to aging tracker data (limited analytics)...');
                    const response = await fetch(`${SUPABASE_CONFIG.url}/rest/v1/${SUPABASE_CONFIG.agingTableName}?select=*&order=created_at.desc`, {
                        headers: {
                            'apikey': SUPABASE_CONFIG.key,
                            'Authorization': `Bearer ${SUPABASE_CONFIG.key}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const agingData = await response.json();
                        console.log(`⚠️ Using ${agingData.length} filtered records (incomplete analytics)`);
                        showMessage(`⚠️ Using limited data from aging tracker (${agingData.length} records). Please set up complete analytics database for full statistics.`, 'warning', 8000);
                        
                        const analyticsData = processCompleteAnalyticsData(agingData);
                        updateDashboardWithRealData(analyticsData);
                        return analyticsData;
                    }
                } catch (fallbackError) {
                    console.error('❌ Fallback also failed:', fallbackError);
                }
                
                // Final fallback to sample data
                showMessage(`❌ Database connection failed: ${error.message}. Using sample data.`, 'error');
                const analyticsData = generateSampleAnalytics();
                updateDashboardWithRealData(analyticsData);
                return analyticsData;
            }
        }

        // Process complete analytics data
        function processCompleteAnalyticsData(rawData) {
            if (!rawData || rawData.length === 0) {
                return generateSampleAnalytics();
            }

            console.log(`📊 Processing ${rawData.length} complete delivery records`);

            // Calculate KPIs
            const totalDeliveries = rawData.length;
            const recordsWithAging = rawData.filter(d => d.aging !== null && d.aging !== undefined && d.aging > 0);
            const avgDeliveryTime = recordsWithAging.length > 0 
                ? (recordsWithAging.reduce((sum, d) => sum + d.aging, 0) / recordsWithAging.length).toFixed(1)
                : '0.0';

            // Calculate monthly performance (current vs previous)
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const thisMonthData = rawData.filter(d => {
                if (!d.order_received) return false;
                const orderDate = new Date(d.order_received);
                return orderDate.getMonth() === currentMonth && orderDate.getFullYear() === currentYear;
            });
            
            const lastMonthData = rawData.filter(d => {
                if (!d.order_received) return false;
                const orderDate = new Date(d.order_received);
                const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
                const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;
                return orderDate.getMonth() === lastMonth && orderDate.getFullYear() === lastMonthYear;
            });

            const thisMonthCount = thisMonthData.length;
            const lastMonthCount = lastMonthData.length;
            const monthlyChangePercent = lastMonthCount > 0 
                ? (((thisMonthCount - lastMonthCount) / lastMonthCount) * 100).toFixed(1)
                : '0.0';

            // Calculate last 7 days volume
            const last7Days = getLastNDays(7);
            const volumeData = last7Days.map((date, index) => {
                const dayData = rawData.filter(d => {
                    if (!d.order_received) return false;
                    const orderDate = new Date(d.order_received);
                    return orderDate.toDateString() === date.toDateString();
                });
                
                // Calculate previous week same day for comparison
                const prevWeekDate = new Date(date);
                prevWeekDate.setDate(prevWeekDate.getDate() - 7);
                const prevWeekData = rawData.filter(d => {
                    if (!d.order_received) return false;
                    const orderDate = new Date(d.order_received);
                    return orderDate.toDateString() === prevWeekDate.toDateString();
                });
                
                const change = prevWeekData.length > 0 ? dayData.length - prevWeekData.length : 0;
                
                return {
                    day: date.toLocaleDateString('en-MY', { weekday: 'short' }),
                    count: dayData.length,
                    change: change,
                    changePercent: prevWeekData.length > 0 ? (((dayData.length - prevWeekData.length) / prevWeekData.length) * 100).toFixed(1) : '0'
                };
            });

            // Calculate service types
            const serviceTypes = {};
            rawData.forEach(delivery => {
                const type = delivery.type || 'Unknown';
                serviceTypes[type] = (serviceTypes[type] || 0) + 1;
            });

            const serviceData = Object.entries(serviceTypes)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 6)
                .map(([type, count]) => ({
                    type,
                    count,
                    percentage: ((count / totalDeliveries) * 100).toFixed(1)
                }));

            // Calculate weekly targets
            const last4Weeks = getLastNWeeks(4);
            const weeklyData = last4Weeks.map((week, index) => {
                const weekData = rawData.filter(d => {
                    if (!d.order_received) return false;
                    const orderDate = new Date(d.order_received);
                    return orderDate >= week.start && orderDate <= week.end;
                });
                
                const target = 80 + (index * 10); // Progressive targets
                const actual = weekData.length;
                const status = actual >= target ? 'Met' : 'Below';
                
                return {
                    week: `Week ${index + 1}`,
                    target,
                    actual,
                    status,
                    percentage: target > 0 ? ((actual / target) * 100).toFixed(1) : '0'
                };
            });

            // Calculate customer performance
            const customerStats = {};
            rawData.forEach(delivery => {
                const customer = delivery.customer || 'Unknown';
                if (!customerStats[customer]) {
                    customerStats[customer] = { total: 0, onTime: 0, totalAging: 0, agingCount: 0 };
                }
                customerStats[customer].total++;
                
                if (delivery.aging !== null && delivery.aging !== undefined && delivery.aging > 0) {
                    customerStats[customer].agingCount++;
                    customerStats[customer].totalAging += delivery.aging;
                    if (delivery.aging <= 3) customerStats[customer].onTime++;
                }
            });

            const topCustomers = Object.entries(customerStats)
                .filter(([_, stats]) => stats.total >= 2)
                .sort((a, b) => b[1].total - a[1].total)
                .slice(0, 10)
                .map(([customer, stats]) => {
                    const onTimeRate = stats.agingCount > 0 ? ((stats.onTime / stats.agingCount) * 100).toFixed(1) : 'N/A';
                    const avgDeliveryTime = stats.agingCount > 0 ? (stats.totalAging / stats.agingCount).toFixed(1) : 'N/A';
                    
                    let status = 'Unknown';
                    if (stats.agingCount > 0) {
                        const rate = stats.onTime / stats.agingCount;
                        status = rate > 0.95 ? 'Excellent' : rate > 0.90 ? 'Good' : 'Needs Improvement';
                    }
                    
                    return {
                        customer,
                        totalOrders: stats.total,
                        onTimeRate,
                        avgDeliveryTime,
                        status
                    };
                });

            return {
                kpis: {
                    totalDeliveries,
                    avgDeliveryTime
                },
                monthly: {
                    thisMonth: thisMonthCount,
                    lastMonth: lastMonthCount,
                    change: monthlyChangePercent
                },
                volume: volumeData,
                services: serviceData,
                targets: weeklyData,
                customers: topCustomers
            };
        }

        function generateSampleAnalytics() {
            return {
                kpis: {
                    totalDeliveries: 1247,
                    avgDeliveryTime: '2.1'
                },
                monthly: {
                    thisMonth: 342,
                    lastMonth: 298,
                    change: '14.8'
                },
                volume: [
                    { day: 'Mon', count: 45, change: 3, changePercent: '7.1' },
                    { day: 'Tue', count: 52, change: -2, changePercent: '-3.7' },
                    { day: 'Wed', count: 48, change: 5, changePercent: '11.6' },
                    { day: 'Thu', count: 61, change: 8, changePercent: '15.1' },
                    { day: 'Fri', count: 58, change: -1, changePercent: '-1.7' },
                    { day: 'Sat', count: 43, change: 2, changePercent: '4.9' },
                    { day: 'Sun', count: 35, change: -3, changePercent: '-7.9' }
                ],
                services: [
                    { type: 'Installation', count: 450, percentage: '36.1' },
                    { type: 'Maintenance', count: 320, percentage: '25.7' },
                    { type: 'Repair', count: 280, percentage: '22.5' },
                    { type: 'Delivery', count: 150, percentage: '12.0' },
                    { type: 'Consultation', count: 47, percentage: '3.7' }
                ],
                targets: [
                    { week: 'Week 1', target: 80, actual: 95, status: 'Met', percentage: '118.8' },
                    { week: 'Week 2', target: 90, actual: 108, status: 'Met', percentage: '120.0' },
                    { week: 'Week 3', target: 100, actual: 89, status: 'Below', percentage: '89.0' },
                    { week: 'Week 4', target: 110, actual: 118, status: 'Met', percentage: '107.3' }
                ],
                customers: [
                    { customer: 'Acme Corporation', totalOrders: 156, onTimeRate: '97.4', avgDeliveryTime: '1.8', status: 'Excellent' },
                    { customer: 'Tech Solutions Ltd', totalOrders: 89, onTimeRate: '94.7', avgDeliveryTime: '2.1', status: 'Good' },
                    { customer: 'Global Industries', totalOrders: 124, onTimeRate: '89.5', avgDeliveryTime: '2.6', status: 'Needs Improvement' }
                ]
            };
        }

        function updateDashboardWithRealData(analyticsData) {
            // Update KPI cards
            document.getElementById('totalDeliveries').textContent = analyticsData.kpis.totalDeliveries.toLocaleString();
            document.getElementById('avgDeliveryTime').textContent = analyticsData.kpis.avgDeliveryTime;

            // Update volume table
            updateVolumeTable(analyticsData.volume);
            
            // Update service table
            updateServiceTable(analyticsData.services);
            
            // Update monthly card
            updateMonthlyCard(analyticsData.monthly);
            
            // Update targets table
            updateTargetsTable(analyticsData.targets);
            
            // Update customer table
            updateCustomerTable(analyticsData.customers);

            console.log('📈 Dashboard updated with analytics data');
        }

        function updateVolumeTable(volumeData) {
            const tbody = document.getElementById('volumeTableBody');
            tbody.innerHTML = volumeData.map(item => `
                <tr>
                    <td style="padding: 0.5rem;">${item.day}</td>
                    <td style="padding: 0.5rem; text-align: right; font-weight: 600;">${item.count}</td>
                    <td style="padding: 0.5rem; text-align: right; color: ${item.change >= 0 ? 'var(--success)' : 'var(--error)'};">
                        ${item.change >= 0 ? '+' : ''}${item.change} (${item.changePercent}%)
                    </td>
                </tr>
            `).join('');
        }

        function updateServiceTable(serviceData) {
            const tbody = document.getElementById('serviceTableBody');
            tbody.innerHTML = serviceData.map(item => `
                <tr>
                    <td style="padding: 0.5rem;">${item.type}</td>
                    <td style="padding: 0.5rem; text-align: right; font-weight: 600;">${item.count}</td>
                    <td style="padding: 0.5rem; text-align: right;">${item.percentage}%</td>
                </tr>
            `).join('');
        }

        function updateMonthlyCard(monthlyData) {
            document.getElementById('thisMonthCount').textContent = monthlyData.thisMonth.toLocaleString();
            document.getElementById('lastMonthCount').textContent = monthlyData.lastMonth.toLocaleString();
            
            const changeElement = document.getElementById('monthlyChange');
            const change = parseFloat(monthlyData.change);
            const isPositive = change >= 0;
            
            changeElement.textContent = `${isPositive ? '+' : ''}${monthlyData.change}% vs previous month`;
            changeElement.style.background = isPositive ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)';
            changeElement.style.color = isPositive ? 'var(--success)' : 'var(--error)';
        }

        function updateTargetsTable(targetsData) {
            const tbody = document.getElementById('targetsTableBody');
            tbody.innerHTML = targetsData.map(item => `
                <tr>
                    <td style="padding: 0.5rem;">${item.week}</td>
                    <td style="padding: 0.5rem; text-align: right;">${item.target}</td>
                    <td style="padding: 0.5rem; text-align: right; font-weight: 600;">${item.actual}</td>
                    <td style="padding: 0.5rem; text-align: right;">
                        <span style="color: ${item.status === 'Met' ? 'var(--success)' : 'var(--error)'}; font-weight: 600;">
                            ${item.status} (${item.percentage}%)
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function updateCustomerTable(customers) {
            const tableBody = document.getElementById('customerTable');
            if (!customers || customers.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="no-data">No customer data available</td></tr>';
                return;
            }

            tableBody.innerHTML = customers.map(customer => `
                <tr>
                    <td><strong>${customer.customer}</strong></td>
                    <td>${customer.totalOrders}</td>
                    <td>${customer.onTimeRate === 'N/A' ? 'N/A' : customer.onTimeRate + '%'}</td>
                    <td>${customer.avgDeliveryTime === 'N/A' ? 'N/A' : customer.avgDeliveryTime + ' days'}</td>
                    <td><span class="status-badge status-${customer.status.toLowerCase().replace(' ', '-')}">${customer.status}</span></td>
                </tr>
            `).join('');
        }

        // Helper functions
        function getLastNDays(n) {
            const days = [];
            for (let i = n - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                days.push(date);
            }
            return days;
        }

        function getLastNWeeks(n) {
            const weeks = [];
            for (let i = n - 1; i >= 0; i--) {
                const endDate = new Date();
                endDate.setDate(endDate.getDate() - (i * 7));
                const startDate = new Date(endDate);
                startDate.setDate(startDate.getDate() - 6);
                weeks.push({ start: startDate, end: endDate });
            }
            return weeks;
        }

        function showLoadingState() {
            document.getElementById('volumeTableBody').innerHTML = '<tr><td colspan="3" class="loading">Loading volume data...</td></tr>';
            document.getElementById('serviceTableBody').innerHTML = '<tr><td colspan="3" class="loading">Loading service data...</td></tr>';
            document.getElementById('targetsTableBody').innerHTML = '<tr><td colspan="4" class="loading">Loading targets data...</td></tr>';
            document.getElementById('customerTable').innerHTML = '<tr><td colspan="5" class="loading">Loading customer data...</td></tr>';
            document.getElementById('thisMonthCount').textContent = '-';
            document.getElementById('lastMonthCount').textContent = '-';
            document.getElementById('monthlyChange').textContent = 'Loading...';
        }

        function hideLoadingState() {
            console.log('Data loading complete');
        }

        // Event handlers
        function setupEventHandlers() {
            document.querySelectorAll('.nav-pill').forEach(pill => {
                pill.addEventListener('click', (e) => {
                    if (e.target.getAttribute('href') === '/aging.html') return; // Skip for navigation link
                    
                    e.preventDefault();
                    document.querySelectorAll('.nav-pill').forEach(p => p.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    showMessage(`Filtering data for ${e.target.textContent}`, 'info', 2000);
                    // Here you would filter data based on the selected period
                });
            });
        }

        // Auto-refresh functionality
        function setupAutoRefresh() {
            setInterval(async () => {
                console.log('Auto-refreshing dashboard data...');
                await loadDataFromSupabase();
            }, 5 * 60 * 1000); // 5 minutes
        }

        // Initialize everything when the page loads
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Initializing Delivery Statistics Dashboard...');
            
            // Set up the interface
            setupEventHandlers();
            
            // Load initial data
            showLoadingState();
            const initialData = await loadDataFromSupabase();
            hideLoadingState();
            
            // Set up auto-refresh
            setupAutoRefresh();
            
            // Add animation delays for staggered loading effect
            document.querySelectorAll('.slide-up').forEach((element, index) => {
                element.style.animationDelay = `${index * 0.1}s`;
            });
            
            console.log('✅ Dashboard initialization complete!');
        });
    </script>
</body>
</html>

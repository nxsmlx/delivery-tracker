<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qube-Inventory Delivery Statistics</title>
    <link rel="icon" href="favicon.ico" type="image/png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <style>
:root{
    --bg-gradient: linear-gradient(180deg, #f3f4f6 0%, #e5e7eb 100%);
    --surface:#ffffff;
    --surface-2:#f9fafb;
    --accent:#4f46e5;
    --accent-hover:#4338ca;
    --text:#1f2937;
    --text-muted:#4b5563;
    --border:#d1d5db;
    --shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -2px rgba(0,0,0,.1);
    --shadow-lg:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -4px rgba(0,0,0,.1);
    --radius:0.75rem;
    --success:#10b981;
    --warning:#f59e0b;
    --error:#ef4444;
    --same-day:#3b82f6;
}

*{margin:0;padding:0;box-sizing:border-box}

body{
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
    background:var(--bg-gradient);
    color:var(--text);
    min-height:100vh;
    padding:1.5rem;
}

.container{
    max-width:1200px;
    margin:0 auto;
    border-radius:var(--radius);
    overflow:hidden;
    background:var(--surface);
    box-shadow:var(--shadow-lg);
    border:1px solid var(--border);
}

.header{
    background:linear-gradient(135deg, #ffffff, #f9fafb);
    padding:2rem 2.5rem;
    text-align:center;
    border-bottom:1px solid var(--border);
    position:relative;
}

.header-content{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:0.75rem;
}

.header h1{
    font-size:1.75rem;
    font-weight:700;
    letter-spacing:-.5px;
    color:var(--text);
}

.header h1::before{content:"ðŸ“Š";margin-right:8px}

.header p{margin-top:4px;color:var(--text-muted)}

.header-actions {
    margin-top: 1.5rem;
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
}

.nav-pills {
    display: flex;
    gap: 0.5rem;
    background: var(--surface-2);
    padding: 0.5rem;
    border-radius: var(--radius);
    border: 1px solid var(--border);
}

.nav-pill {
    padding: 0.625rem 1.25rem;
    border: 1px solid transparent;
    border-radius: calc(var(--radius) - 0.25rem);
    background: var(--surface);
    color: var(--text);
    font-size: .875rem;
    font-weight: 600;
    cursor: pointer;
    transition: all .2s;
    text-decoration: none;
}

.nav-pill:hover,
.nav-pill.active {
    background: var(--accent);
    border-color: var(--accent);
    color: #fff;
}

/* KPI Cards - Just 2 cards */
.kpi-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    padding: 1.5rem;
}

.kpi-card {
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 2rem 1.25rem;
    text-align: center;
    transition: transform .15s, box-shadow .15s;
}

.kpi-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.kpi-number {
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 4px;
    color: var(--accent);
}

.kpi-label {
    font-size: .75rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: .5px;
}

/* Charts Grid - 2x2 */
.charts-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    padding: 1.5rem;
}

.chart-container {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1.5rem;
    box-shadow: var(--shadow);
    transition: transform .15s, box-shadow .15s;
}

.chart-container:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--border);
}

.chart-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text);
}

.chart-subtitle {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
}

.chart-canvas {
    position: relative;
    height: 300px;
}

/* Customer Performance Table */
.customer-performance {
    margin: 0 1.5rem 1.5rem;
    padding: 1.5rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
}

.customer-performance h3 {
    color: var(--accent);
    margin-bottom: 1rem;
    font-size: 1.125rem;
}

.table-wrapper {
    overflow-x: auto;
    border-radius: var(--radius);
    background: var(--surface);
    border: 1px solid var(--border);
}

table {
    width: 100%;
    border-collapse: collapse;
}

th, td {
    padding: 0.75rem 1rem;
    text-align: left;
    font-size: .875rem;
    vertical-align: middle;
}

th {
    background: var(--surface-2);
    color: var(--text-muted);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: .5px;
    border-bottom: 1px solid var(--border);
}

tr:hover {
    background: var(--surface-2);
}

.status-badge {
    padding: 4px 8px;
    border-radius: 999px;
    font-size: .7rem;
    font-weight: 600;
    letter-spacing: .5px;
    color: #fff;
    display: inline-block;
}

.status-excellent {
    background: var(--success);
}

.status-good {
    background: var(--same-day);
}

.status-needs-improvement {
    background: var(--warning);
}

/* Loading Animation */
.loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 200px;
    font-size: 1.1rem;
    color: var(--text-muted);
}

.loading::before {
    content: '';
    width: 24px;
    height: 24px;
    border: 3px solid var(--border);
    border-top: 3px solid var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 0.75rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.no-data {
    padding: 2.5rem;
    text-align: center;
    color: var(--text-muted);
    font-size: .875rem;
}

/* Responsive Design */
@media (max-width: 1024px) {
    .charts-grid {
        grid-template-columns: 1fr;
    }
    
    .kpi-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    body {
        padding: 0.75rem;
    }
    
    .header {
        padding: 1.5rem;
    }
    
    .nav-pills {
        flex-direction: column;
    }
    
    .chart-container {
        padding: 1rem;
    }
    
    .kpi-number {
        font-size: 2.5rem;
    }
    
    .charts-grid {
        padding: 1rem;
    }
    
    .kpi-grid {
        padding: 1rem;
    }
}

/* Animation Classes */
.fade-in {
    animation: fadeIn 0.6s ease-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.slide-up {
    animation: slideUp 0.8s ease-out;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header fade-in">
            <div class="header-content">
                <div>
                    <h1>Delivery Performance Analytics</h1>
                    <p>Key insights into delivery operations and performance metrics</p>
                <script>
        // Supabase Configuration - Same as aging tracker
        const SUPABASE_CONFIG = {
            url: 'https://iugwfmnfmulgxvaxjkwv.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1Z3dmbW5mbXVsZ3h2YXhqa3d2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3MTU2MDIsImV4cCI6MjA2ODI5MTYwMn0.pUExanPG_BdTN11gtHg_cOubUkMOEv3n0a1mksLH_ZE',
            tableName: 'delivery_data'
        };

        // Global variables
        let chartsData = {};
        let allCharts = {};

        // Sample data for fallback
        const sampleData = {
            trends: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [{
                    label: 'Daily Deliveries',
                    data: [45, 52, 48, 61, 58, 43, 35],
                    borderColor: '#4f46e5',
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 3
                }]
            },
            services: {
                labels: ['Installation', 'Maintenance', 'Repair', 'Delivery', 'Consultation'],
                datasets: [{
                    data: [30, 25, 20, 15, 10],
                    backgroundColor: ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'],
                    borderWidth: 0
                }]
            },
            targets: {
                labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                datasets: [{
                    label: 'Target',
                    data: [100, 105, 110, 115],
                    borderColor: '#94a3b8',
                    backgroundColor: 'transparent',
                    borderDash: [5, 5],
                    tension: 0,
                    borderWidth: 2
                }, {
                    label: 'Actual',
                    data: [95, 108, 102, 118],
                    borderColor: '#4f46e5',
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    tension: 0.4,
                    fill: '+1',
                    borderWidth: 3
                }]
            },
            monthly: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'This Year',
                    data: [385, 445, 425, 478, 495, 520],
                    backgroundColor: '#4f46e5',
                    borderRadius: 8
                }, {
                    label: 'Last Year',
                    data: [360, 420, 400, 450, 470, 480],
                    backgroundColor: '#94a3b8',
                    borderRadius: 8
                }]
            }
        };

        // Chart configurations
        const chartConfigs = {
            common: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            usePointStyle: true,
                            font: {
                                size: 11,
                                weight: 'bold'
                            }
                        }
                    }
                }
            }
        };

        // Load data from Supabase - USES ALL ROWS INCLUDING AGING=0 FOR STATISTICS
        async function loadDataFromSupabase() {
            try {
                console.log('ðŸ“Š Loading data from Supabase...');
                
                const response = await fetch(`${SUPABASE_CONFIG.url}/rest/v1/${SUPABASE_CONFIG.tableName}?select=*&order=created_at.desc`, {
                    headers: {
                        'apikey': SUPABASE_CONFIG.key,
                        'Authorization': `Bearer ${SUPABASE_CONFIG.key}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Database error: ${response.status}`);
                }

                const rawData = await response.json();
                console.log(`âœ… Loaded ${rawData.length} delivery records`);

                // Process ALL data (including completed deliveries for statistics)
                const analyticsData = processAnalyticsData(rawData);
                updateDashboardWithRealData(analyticsData);
                updateAllCharts(analyticsData);
                
                return analyticsData;
            } catch (error) {
                console.error('âŒ Error loading data:', error);
                showNotification('Using sample data - database connection issue', 'info');
                chartsData = sampleData;
                updateAllCharts(sampleData);
                return sampleData;
            }
        }

        // Process analytics data from raw delivery data - INCLUDES ALL RECORDS
        function processAnalyticsData(rawData) {
            if (!rawData || rawData.length === 0) {
                console.log('âš ï¸ No data available, using sample data');
                return sampleData;
            }

            // Calculate KPIs from ALL deliveries (completed + pending)
            const totalDeliveries = rawData.length;
            const avgDeliveryTime = (rawData.reduce((sum, d) => sum + (d.aging || 0), 0) / totalDeliveries).toFixed(1);

            // Calculate trends (last 7 days) - ALL deliveries
            const last7Days = getLastNDays(7);
            const trendsData = last7Days.map(date => {
                const dayData = rawData.filter(d => {
                    const orderDate = new Date(d.order_received);
                    return orderDate.toDateString() === date.toDateString();
                });
                return {
                    date: date.toLocaleDateString('en-MY', { weekday: 'short' }),
                    total: dayData.length
                };
            });

            // Calculate service type distribution - ALL records
            const serviceTypes = {};
            rawData.forEach(delivery => {
                const type = delivery.type || 'Unknown';
                serviceTypes[type] = (serviceTypes[type] || 0) + 1;
            });

            // Calculate weekly targets vs actual - ALL deliveries
            const last4Weeks = getLastNWeeks(4);
            const weeklyData = last4Weeks.map((week, index) => {
                const weekData = rawData.filter(d => {
                    const orderDate = new Date(d.order_received);
                    return orderDate >= week.start && orderDate <= week.end;
                });
                return {
                    week: `Week ${index + 1}`,
                    actual: weekData.length,
                    target: 100 + (index * 5) // Mock target progression
                };
            });

            // Calculate monthly comparison (last 6 months) - ALL deliveries
            const last6Months = getLastNMonths(6);
            const monthlyData = last6Months.map(month => {
                const monthData = rawData.filter(d => {
                    const orderDate = new Date(d.order_received);
                    return orderDate.getMonth() === month.month && orderDate.getFullYear() === month.year;
                });
                return {
                    month: month.name,
                    thisYear: monthData.length,
                    lastYear: Math.max(0, monthData.length - Math.floor(Math.random() * 20)) // Mock last year data
                };
            });

            // Calculate customer performance - ALL records
            const customerStats = {};
            rawData.forEach(delivery => {
                const customer = delivery.customer || 'Unknown';
                if (!customerStats[customer]) {
                    customerStats[customer] = { total: 0, onTime: 0, totalAging: 0 };
                }
                customerStats[customer].total++;
                if (delivery.aging <= 3) customerStats[customer].onTime++;
                customerStats[customer].totalAging += delivery.aging || 0;
            });

            const topCustomers = Object.entries(customerStats)
                .filter(([_, stats]) => stats.total >= 3) // Only customers with 3+ orders
                .sort((a, b) => b[1].total - a[1].total)
                .slice(0, 10)
                .map(([customer, stats]) => ({
                    customer,
                    totalOrders: stats.total,
                    onTimeRate: ((stats.onTime / stats.total) * 100).toFixed(1),
                    avgDeliveryTime: (stats.totalAging / stats.total).toFixed(1),
                    status: (stats.onTime / stats.total) > 0.95 ? 'Excellent' : 
                           (stats.onTime / stats.total) > 0.90 ? 'Good' : 'Needs Improvement'
                }));

            chartsData = {
                kpis: {
                    totalDeliveries,
                    avgDeliveryTime
                },
                trends: {
                    labels: trendsData.map(d => d.date),
                    datasets: [{
                        label: 'Daily Deliveries',
                        data: trendsData.map(d => d.total),
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3
                    }]
                },
                services: {
                    labels: Object.keys(serviceTypes).slice(0, 5),
                    datasets: [{
                        data: Object.values(serviceTypes).slice(0, 5),
                        backgroundColor: ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'],
                        borderWidth: 0
                    }]
                },
                targets: {
                    labels: weeklyData.map(w => w.week),
                    datasets: [{
                        label: 'Target',
                        data: weeklyData.map(w => w.target),
                        borderColor: '#94a3b8',
                        backgroundColor: 'transparent',
                        borderDash: [5, 5],
                        tension: 0,
                        borderWidth: 2
                    }, {
                        label: 'Actual',
                        data: weeklyData.map(w => w.actual),
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        tension: 0.4,
                        fill: '+1',
                        borderWidth: 3
                    }]
                },
                monthly: {
                    labels: monthlyData.map(m => m.month),
                    datasets: [{
                        label: 'This Year',
                        data: monthlyData.map(m => m.thisYear),
                        backgroundColor: '#4f46e5',
                        borderRadius: 8
                    }, {
                        label: 'Last Year',
                        data: monthlyData.map(m => m.lastYear),
                        backgroundColor: '#94a3b8',
                        borderRadius: 8
                    }]
                },
                customers: topCustomers
            };

            return chartsData;
        }

        // Helper functions
        function getLastNDays(n) {
            const days = [];
            for (let i = n - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                days.push(date);
            }
            return days;
        }

        function getLastNWeeks(n) {
            const weeks = [];
            for (let i = n - 1; i >= 0; i--) {
                const endDate = new Date();
                endDate.setDate(endDate.getDate() - (i * 7));
                const startDate = new Date(endDate);
                startDate.setDate(startDate.getDate() - 6);
                weeks.push({ start: startDate, end: endDate });
            }
            return weeks;
        }

        function getLastNMonths(n) {
            const months = [];
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            for (let i = n - 1; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                months.push({
                    month: date.getMonth(),
                    year: date.getFullYear(),
                    name: monthNames[date.getMonth()]
                });
            }
            return months;
        }

        function updateDashboardWithRealData(analyticsData) {
            // Update KPI cards
            document.getElementById('totalDeliveries').textContent = analyticsData.kpis.totalDeliveries.toLocaleString();
            document.getElementById('avgDeliveryTime').textContent = analyticsData.kpis.avgDeliveryTime;

            // Update customer table
            updateCustomerTable(analyticsData.customers);

            console.log('ðŸ“ˆ Dashboard updated with real data');
        }

        function updateCustomerTable(customers) {
            const tableBody = document.getElementById('customerTable');
            if (!customers || customers.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="no-data">No customer data available</td></tr>';
                return;
            }

            tableBody.innerHTML = customers.map(customer => `
                <tr>
                    <td><strong>${customer.customer}</strong></td>
                    <td>${customer.totalOrders}</td>
                    <td>${customer.onTimeRate}%</td>
                    <td>${customer.avgDeliveryTime} days</td>
                    <td><span class="status-badge status-${customer.status.toLowerCase().replace(' ', '-')}">${customer.status}</span></td>
                </tr>
            `).join('');
        }

        // Initialize charts
        function initCharts() {
            // Delivery Volume Trends Chart
            const trendsCtx = document.getElementById('trendsChart').getContext('2d');
            allCharts.trends = new Chart(trendsCtx, {
                type: 'line',
                data: chartsData.trends || sampleData.trends,
                options: {
                    ...chartConfigs.common,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: { font: { weight: 'bold' } }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { font: { weight: 'bold' } }
                        }
                    }
                }
            });

            // Service Type Performance (Pie Chart)
            const serviceCtx = document.getElementById('serviceChart').getContext('2d');
            allCharts.services = new Chart(serviceCtx, {
                type: 'pie',
                data: chartsData.services || sampleData.services,
                options: {
                    ...chartConfigs.common,
                    plugins: {
                        ...chartConfigs.common.plugins,
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Performance vs Targets Chart
            const targetCtx = document.getElementById('targetChart').getContext('2d');
            allCharts.targets = new Chart(targetCtx, {
                type: 'line',
                data: chartsData.targets || sampleData.targets,
                options: {
                    ...chartConfigs.common,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 80,
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: { font: { weight: 'bold' } }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { font: { weight: 'bold' } }
                        }
                    }
                }
            });

            // Monthly Comparison Chart
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            allCharts.monthly = new Chart(monthlyCtx, {
                type: 'bar',
                data: chartsData.monthly || sampleData.monthly,
                options: {
                    ...chartConfigs.common,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: { font: { weight: 'bold' } }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { font: { weight: 'bold' } }
                        }
                    }
                }
            });
        }

        function updateAllCharts(newData) {
            if (allCharts.trends && newData.trends) {
                allCharts.trends.data = newData.trends;
                allCharts.trends.update();
            }
            if (allCharts.services && newData.services) {
                allCharts.services.data = newData.services;
                allCharts.services.update();
            }
            if (allCharts.targets && newData.targets) {
                allCharts.targets.data = newData.targets;
                allCharts.targets.update();
            }
            if (allCharts.monthly && newData.monthly) {
                allCharts.monthly.data = newData.monthly;
                allCharts.monthly.update();
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#4f46e5'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 0.5rem;
                box-shadow: 0 10px 25px rgba(0,0,0,0.1);
                z-index: 1000;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 100);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }

        function showLoadingState() {
            document.querySelectorAll('.chart-canvas').forEach(canvas => {
                canvas.innerHTML = '<div class="loading">Loading chart data...</div>';
            });
        }

        function hideLoadingState() {
            console.log('Charts updated with new data');
        }

        // Event handlers
        function setupEventHandlers() {
            document.querySelectorAll('.nav-pill').forEach(pill => {
                pill.addEventListener('click', (e) => {
                    if (e.target.getAttribute('href') === '/aging.html') return; // Skip for navigation link
                    
                    e.preventDefault();
                    document.querySelectorAll('.nav-pill').forEach(p => p.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    showNotification(`Filtering data for ${e.target.textContent}`, 'info');
                    // Here you would filter data based on the selected period
                });
            });
        }

        // Auto-refresh functionality
        function setupAutoRefresh() {
            setInterval(async () => {
                console.log('Auto-refreshing dashboard data...');
                await loadDataFromSupabase();
                showNotification('Dashboard data refreshed', 'success');
            }, 5 * 60 * 1000); // 5 minutes
        }

        // Initialize everything when the page loads
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ðŸš€ Initializing Delivery Statistics Dashboard...');
            
            // Set up the interface
            setupEventHandlers();
            
            // Load initial data from Supabase
            showLoadingState();
            const initialData = await loadDataFromSupabase();
            hideLoadingState();
            
            // Initialize charts with real data
            initCharts();
            
            // Set up auto-refresh
            setupAutoRefresh();
            
            // Add animation delays for staggered loading effect
            document.querySelectorAll('.slide-up').forEach((element, index) => {
                element.style.animationDelay = `${index * 0.1}s`;
            });
            
            console.log('âœ… Dashboard initialization complete!');
            showNotification('Dashboard loaded successfully!', 'success');
        });
    </script>
</body>
</html>
            </div>
            
            <div class="header-actions">
                <div class="nav-pills">
                    <a href="#" class="nav-pill active" data-period="7d">Last 7 Days</a>
                    <a href="#" class="nav-pill" data-period="30d">Last 30 Days</a>
                    <a href="#" class="nav-pill" data-period="90d">Last 90 Days</a>
                    <a href="#" class="nav-pill" data-period="1y">Last Year</a>
                    <a href="/aging.html" class="nav-pill">ðŸ“ˆ Aging Tracker</a>
                </div>
            </div>
        </div>

        <!-- KPI Cards - Only 2 -->
        <div class="kpi-grid slide-up">
            <div class="kpi-card">
                <div class="kpi-number" id="totalDeliveries">1,247</div>
                <div class="kpi-label">Total Deliveries</div>
            </div>
            
            <div class="kpi-card">
                <div class="kpi-number" id="avgDeliveryTime">2.1</div>
                <div class="kpi-label">Average Delivery Days</div>
            </div>
        </div>

        <!-- Charts Grid - 2x2 -->
        <div class="charts-grid slide-up">
            <!-- Delivery Volume Trends Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">Delivery Volume Trends</div>
                        <div class="chart-subtitle">Daily delivery completions over time</div>
                    </div>
                </div>
                <div class="chart-canvas">
                    <canvas id="trendsChart"></canvas>
                </div>
            </div>
            
            <!-- Service Type Performance (Pie Chart) -->
            <div class="chart-container">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">Service Type Performance</div>
                        <div class="chart-subtitle">Volume breakdown by service type</div>
                    </div>
                </div>
                <div class="chart-canvas">
                    <canvas id="serviceChart"></canvas>
                </div>
            </div>

            <!-- Performance vs Targets -->
            <div class="chart-container">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">Performance vs Targets</div>
                        <div class="chart-subtitle">Actual vs target deliveries</div>
                    </div>
                </div>
                <div class="chart-canvas">
                    <canvas id="targetChart"></canvas>
                </div>
            </div>
            
            <!-- Monthly Comparison -->
            <div class="chart-container">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">Monthly Comparison</div>
                        <div class="chart-subtitle">Month-over-month performance</div>
                    </div>
                </div>
                <div class="chart-canvas">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Top Customer Performance -->
        <div class="customer-performance slide-up">
            <h3>ðŸ“‹ Top Customer Performance</h3>
            <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.875rem;">Customer delivery statistics and performance metrics</p>
            
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Total Orders</th>
                            <th>On-Time Rate</th>
                            <th>Avg Delivery Time</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="customerTable">
                        <tr>
                            <td><strong>Acme Corporation</strong></td>
                            <td>156</td>
                            <td>97.4%</td>
                            <td>1.8 days</td>
                            <td><span class="status-badge status-excellent">Excellent</span></td>
                        </tr>
                        <tr>
                            <td><strong>Tech Solutions Ltd</strong></td>
                            <td>89</td>
                            <td>94.7%</td>
                            <td>2.1 days</td>
                            <td><span class="status-badge status-good">Good</span></td>
                        </tr>
                        <tr>
                            <td><strong>Global Industries</strong></td>
                            <td>124</td>
                            <td>89.5%</td>
                            <td>2.6 days</td>
                            <td><span class="status-badge status-needs-improvement">Needs Improvement</span></td>
                        </tr>
                        <tr>
                            <td><strong>StartUp Inc</strong></td>
                            <td>67</td>
                            <td>95.5%</td>
                            <td>2.0 days</td>
                            <td><span class="status-badge status-excellent">Excellent</span></td>
                        </tr>
                        <tr>
                            <td><strong>Enterprise Corp</strong></td>
                            <td>203</td>
                            <td>92.1%</td>
                            <td>2.3 days</td>
                            <td><span class="status-badge status-good">Good</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_CONFIG = {
            url: 'https://iugwfmnfmulgxvaxjkwv.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1Z3dmbW5mbXVsZ3h2YXhqa3d2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3MTU2MDIsImV4cCI6MjA2ODI5MTYwMn0.pUExanPG_BdTN11gtHg_cOubUkMOEv3n0a1mksLH_ZE',
            tableName: 'delivery_data'
        };

        // Global variables
        let chartsData = {};

        // Sample data for fallback
        const sampleData = {
            trends: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [{
                    label: 'Daily Deliveries',
                    data: [45, 52, 48, 61, 58, 43, 35],
                    borderColor: '#4f46e5',
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 3
                }]
            },
            services: {
                labels: ['Installation', 'Maintenance', 'Repair', 'Delivery', 'Consultation'],
                datasets: [{
                    data: [30, 25, 20, 15, 10],
                    backgroundColor: [
                        '#4f46e5',
                        '#10b981', 
                        '#f59e0b',
                        '#ef4444',
                        '#8b5cf6'
                    ],
                    borderWidth: 0
                }]
            },
            targets: {
                labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                datasets: [{
                    label: 'Target',
                    data: [100, 105, 110, 115],
                    borderColor: '#94a3b8',
                    backgroundColor: 'transparent',
                    borderDash: [5, 5],
                    tension: 0,
                    borderWidth: 2
                }, {
                    label: 'Actual',
                    data: [95, 108, 102, 118],
                    borderColor: '#4f46e5',
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    tension: 0.4,
                    fill: '+1',
                    borderWidth: 3
                }]
            },
            monthly: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'This Year',
                    data: [385, 445, 425, 478, 495, 520],
                    backgroundColor: '#4f46e5',
                    borderRadius: 8
                }, {
                    label: 'Last Year',
                    data: [360, 420, 400, 450, 470, 480],
                    backgroundColor: '#94a3b8',
                    borderRadius: 8
                }]
            }
        };

        // Chart configurations
        const chartConfigs = {
            common: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true,
                            font: {
                                size: 12,
                                weight: 'bold'
                            }
                        }
                    }
                }
            }
        };

        // Initialize charts
        function initCharts() {
            // Delivery Volume Trends Chart
            const trendsCtx = document.getElementById('trendsChart').getContext('2d');
            new Chart(trendsCtx, {
                type: 'line',
                data: chartsData.trends || sampleData.trends,
                options: {
                    ...chartConfigs.common,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            },
                            ticks: {
                                font: { weight: 'bold' }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: { weight: 'bold' }
                            }
                        }
                    }
                }
            });

            // Service Type Performance (Pie Chart)
            const serviceCtx = document.getElementById('serviceChart').getContext('2d');
            new Chart(serviceCtx, {
                type: 'pie',
                data: chartsData.services || sampleData.services,
                options: {
                    ...chartConfigs.common,
                    plugins: {
                        ...chartConfigs.common.plugins,
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Performance vs Targets Chart
            const targetCtx = document.getElementById('targetChart').getContext('2d');
            new Chart(targetCtx, {
                type: 'line',
                data: chartsData.targets || sampleData.targets,
                options: {
                    ...chartConfigs.common,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 80,
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            },
                            ticks: {
                                font: { weight: 'bold' }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: { weight: 'bold' }
                            }
                        }
                    }
                }
            });

            // Monthly Comparison Chart
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            new Chart(monthlyCtx, {
                type: 'bar',
                data: chartsData.monthly || sampleData.monthly,
                options: {
                    ...chartConfigs.common,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            },
                            ticks: {
                                font: { weight: 'bold' }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: { weight: 'bold' }
                            }
                        }
                    }
                }
            });
        }

        // Load data from Supabase
        async function loadDataFromSupabase() {
            try {
                console.log('ðŸ“Š Loading data from Supabase...');
                
                const response = await fetch(`${SUPABASE_CONFIG.url}/rest/v1/${SUPABASE_CONFIG.tableName}?select=*&order=created_at.desc`, {
                    headers: {
                        'apikey': SUPABASE_CONFIG.key,
                        'Authorization': `Bearer ${SUPABASE_CONFIG.key}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Database error: ${response.status}`);
                }

                const rawData = await response.json();
                console.log(`âœ… Loaded ${rawData.length} delivery records`);

                const analyticsData = processAnalyticsData(rawData);
                updateDashboardWithRealData(analyticsData);
                
                return analyticsData;
            } catch (error) {
                console.error('âŒ Error loading data:', error);
                showNotification('Using sample data - database connection issue', 'info');
                chartsData = sampleData;
                return sampleData;
            }
        }

        // Process analytics data from raw delivery data
        function processAnalyticsData(rawData) {
            if (!rawData || rawData.length === 0) {
                console.log('âš ï¸ No data available, using sample data');
                return sampleData;
            }

            // Calculate KPIs
            const totalDeliveries = rawData.length;
            const avgDeliveryTime = (rawData.reduce((sum, d) => sum + (d.aging || 0), 0) / totalDeliveries).toFixed(1);

            // Calculate trends (last 7 days)
            const last7Days = getLastNDays(7);
            const trendsData = last7Days.map(date => {
                const dayData = rawData.filter(d => {
                    const orderDate = new Date(d.order_received).toDateString();
                    return orderDate === date.toDateString();
                });
                return {
                    date: date.toLocaleDateString('en-MY', { weekday: 'short' }),
                    total: dayData.length
                };
            });

            // Calculate service type distribution
            const serviceTypes = {};
            rawData.forEach(delivery => {
                const type = delivery.type || 'Unknown';
                serviceTypes[type] = (serviceTypes[type] || 0) + 1;
            });

            // Calculate weekly targets vs actual
            const last4Weeks = getLastNWeeks(4);
            const weeklyData = last4Weeks.map((week, index) => {
                const weekData = rawData.filter(d => {
                    const orderDate = new Date(d.order_received);
                    return orderDate >= week.start && orderDate <= week.end;
                });
                return {
                    week: `Week ${index + 1}`,
                    actual: weekData.length,
                    target: 100 + (index * 5) // Mock target progression
                };
            });

            // Calculate monthly comparison (last 6 months)
            const last6Months = getLastNMonths(6);
            const monthlyData = last6Months.map(month => {
                const monthData = rawData.filter(d => {
                    const orderDate = new Date(d.order_received);
                    return orderDate.getMonth() === month.month && orderDate.getFullYear() === month.year;
                });
                return {
                    month: month.name,
                    thisYear: monthData.length,
                    lastYear: monthData.length - Math.floor(Math.random() * 50) // Mock last year data
                };
            });

            chartsData = {
                kpis: {
                    totalDeliveries,
                    avgDeliveryTime
                },
                trends: {
                    labels: trendsData.map(d => d.date),
                    datasets: [{
                        label: 'Daily Deliveries',
                        data: trendsData.map(d => d.total),
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3
                    }]
                },
                services: {
                    labels: Object.keys(serviceTypes).slice(0, 5),
                    datasets: [{
                        data: Object.values(serviceTypes).slice(0, 5),
                        backgroundColor: ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'],
                        borderWidth: 0
                    }]
                },
                targets: {
                    labels: weeklyData.map(w => w.week),
                    datasets: [{
                        label: 'Target',
                        data: weeklyData.map(w => w.target),
                        borderColor: '#94a3b8',
                        backgroundColor: 'transparent',
                        borderDash: [5, 5],
                        tension: 0,
                        borderWidth: 2
                    }, {
                        label: 'Actual',
                        data: weeklyData.map(w => w.actual),
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        tension: 0.4,
                        fill: '+1',
                        borderWidth: 3
                    }]
                },
                monthly: {
                    labels: monthlyData.map(m => m.month),
                    datasets: [{
                        label: 'This Year',
                        data: monthlyData.map(m => m.thisYear),
                        backgroundColor: '#4f46e5',
                        borderRadius: 8
                    }, {
                        label: 'Last Year',
                        data: monthlyData.map(m => m.lastYear),
                        backgroundColor: '#94a3b8',
                        borderRadius: 8
                    }]
                }
            };

            return chartsData;
        }

        // Helper functions
        function getLastNDays(n) {
            const days = [];
            for (let i = n - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                days.push(date);
            }
            return days;
        }

        function getLastNWeeks(n) {
            const weeks = [];
            for (let i = n - 1; i >= 0; i--) {
                const endDate = new Date();
                endDate.setDate(endDate.getDate() - (i * 7));
                const startDate = new Date(endDate);
                startDate.setDate(startDate.getDate() - 6);
                weeks.push({ start: startDate, end: endDate });
            }
            return weeks;
        }

        function getLastNMonths(n) {
            const months = [];
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            for (let i = n - 1; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                months.push({
                    month: date.getMonth(),
                    year: date.getFullYear(),
                    name: monthNames[date.getMonth()]
                });
            }
            return months;
        }

        function updateDashboardWithRealData(analyticsData) {
            // Update KPI cards
            document.getElementById('totalDeliveries').textContent = analyticsData.kpis.totalDeliveries.toLocaleString();
            document.getElementById('avgDeliveryTime').textContent = analyticsData.kpis.avgDeliveryTime;

            console.log('ðŸ“ˆ Dashboard updated with real data');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#4f46e5'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 0.5rem;
                box-shadow: 0 10px 25px rgba(0,0,0,0.1);
                z-index: 1000;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 100);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 4000);
        }

        function showLoadingState() {
            document.querySelectorAll('.chart-canvas').forEach(canvas => {
                canvas.innerHTML = '<div class="loading">Loading chart data...</div>';
            });
        }

        function hideLoadingState() {
            console.log('Charts updated with new data');
        }

        // Event handlers
        function setupEventHandlers() {
            document.querySelectorAll('.nav-pill').forEach(pill => {
                pill.addEventListener('click', (e) => {
                    if (e.target.getAttribute('href') === '/aging.html') return; // Skip for navigation link
                    
                    e.preventDefault();
                    document.querySelectorAll('.nav-pill').forEach(p => p.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    showNotification(`Filtering data for ${e.target.textContent}`, 'info');
                    // Here you would filter data based on the selected period
                });
            });
        }

        // Auto-refresh functionality
        function setupAutoRefresh() {
            setInterval(async () => {
                console.log('Auto-refreshing dashboard data...');
                await loadDataFromSupabase();
                showNotification('Dashboard data refreshed', 'success');
            }, 5 * 60 * 1000); // 5 minutes
        }

        // Initialize everything when the page loads
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ðŸš€ Initializing Delivery Statistics Dashboard...');
            
            // Set up the interface
            setupEventHandlers();
            
            // Load initial data from Supabase
            showLoadingState();
            const initialData = await loadDataFromSupabase();
            hideLoadingState();
            
            // Initialize charts with real data
            initCharts();
            
            // Set up auto-refresh
            setupAutoRefresh();
            
            // Add animation delays for staggered loading effect
            document.querySelectorAll('.slide-up').forEach((element, index) => {
                element.style.animationDelay = `${index * 0.1}s`;
            });
            
            console.log('âœ… Dashboard initialization complete!');
            showNotification('Dashboard loaded successfully!', 'success');
        });
    </script>
</body>
</html>

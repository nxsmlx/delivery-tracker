<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qube Delivery Statistics</title>
    <link rel="icon" href="favicon.ico" type="image/png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <style>
:root{
    --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --surface: #ffffff;
    --surface-2: #f8fafc;
    --surface-dark: #1e293b;
    --accent: #4f46e5;
    --accent-hover: #4338ca;
    --text: #1f2937;
    --text-muted: #64748b;
    --text-light: #94a3b8;
    --border: #e2e8f0;
    --shadow: 0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -2px rgba(0,0,0,.1);
    --shadow-lg: 0 20px 25px -5px rgba(0,0,0,.1), 0 10px 10px -5px rgba(0,0,0,.04);
    --shadow-xl: 0 25px 50px -12px rgba(0,0,0,.25);
    --radius: 1rem;
    --success: #10b981;
    --warning: #f59e0b;
    --error: #ef4444;
    --info: #3b82f6;
    --purple: #8b5cf6;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    background: var(--bg-gradient);
    color: var(--text);
    min-height: 100vh;
    padding: 1.5rem;
    line-height: 1.6;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
}

/* Header */
.header {
    background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.9));
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: var(--radius);
    padding: 2rem;
    margin-bottom: 2rem;
    text-align: center;
    box-shadow: var(--shadow-lg);
}

.header h1 {
    font-size: 2.5rem;
    font-weight: 800;
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 0.5rem;
}

.header h1::before {
    content: "üìä";
    margin-right: 12px;
    -webkit-text-fill-color: initial;
}

.header p {
    color: var(--text-muted);
    font-size: 1.1rem;
}

.header-actions {
    margin-top: 1.5rem;
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
}

/* Navigation Pills */
.nav-pills {
    display: flex;
    gap: 0.5rem;
    background: rgba(255,255,255,0.8);
    padding: 0.5rem;
    border-radius: var(--radius);
    backdrop-filter: blur(10px);
}

.nav-pill {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: calc(var(--radius) - 0.25rem);
    background: transparent;
    color: var(--text-muted);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
}

.nav-pill:hover, .nav-pill.active {
    background: var(--accent);
    color: white;
    transform: translateY(-1px);
    box-shadow: var(--shadow);
}

/* Date Range Picker */
.date-range {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    background: rgba(255,255,255,0.9);
    padding: 0.75rem 1rem;
    border-radius: var(--radius);
    border: 1px solid var(--border);
}

.date-range input {
    border: none;
    background: transparent;
    color: var(--text);
    font-weight: 500;
}

.date-range input:focus {
    outline: none;
}

/* KPI Cards Grid */
.kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.kpi-card {
    background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.9));
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: var(--radius);
    padding: 2rem;
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.kpi-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--accent), var(--purple));
}

.kpi-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-xl);
}

.kpi-number {
    font-size: 3rem;
    font-weight: 800;
    margin-bottom: 0.5rem;
    background: linear-gradient(135deg, var(--accent), var(--purple));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.kpi-label {
    font-size: 1rem;
    color: var(--text-muted);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.5rem;
}

.kpi-change {
    font-size: 0.875rem;
    font-weight: 600;
    padding: 0.25rem 0.75rem;
    border-radius: 999px;
    display: inline-block;
}

.kpi-change.positive {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success);
}

.kpi-change.negative {
    background: rgba(239, 68, 68, 0.1);
    color: var(--error);
}

/* Charts Grid */
.charts-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 2rem;
    margin-bottom: 2rem;
}

.chart-container {
    background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.9));
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: var(--radius);
    padding: 2rem;
    box-shadow: var(--shadow-lg);
    transition: all 0.3s ease;
}

.chart-container:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-xl);
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border);
}

.chart-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text);
}

.chart-subtitle {
    font-size: 0.875rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
}

.chart-canvas {
    position: relative;
    height: 300px;
}

/* Wide Charts */
.chart-wide {
    grid-column: 1 / -1;
}

.chart-wide .chart-canvas {
    height: 400px;
}

/* Secondary Grid */
.secondary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 2rem;
    margin-bottom: 2rem;
}

/* Performance Table */
.performance-table {
    background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.9));
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: var(--radius);
    padding: 2rem;
    box-shadow: var(--shadow-lg);
}

.table-wrapper {
    overflow-x: auto;
    border-radius: calc(var(--radius) - 0.5rem);
    border: 1px solid var(--border);
}

table {
    width: 100%;
    border-collapse: collapse;
    background: var(--surface);
}

th, td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid var(--border);
}

th {
    background: var(--surface-2);
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 0.875rem;
}

tr:hover {
    background: var(--surface-2);
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-excellent {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success);
}

.status-good {
    background: rgba(59, 130, 246, 0.1);
    color: var(--info);
}

.status-needs-improvement {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning);
}

/* Export Button */
.export-btn {
    background: linear-gradient(135deg, var(--accent), var(--purple));
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: var(--radius);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: var(--shadow);
}

.export-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

/* Loading Animation */
.loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 200px;
    font-size: 1.1rem;
    color: var(--text-muted);
}

.loading::before {
    content: '';
    width: 24px;
    height: 24px;
    border: 3px solid var(--border);
    border-top: 3px solid var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 0.75rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Responsive Design */
@media (max-width: 1024px) {
    .charts-grid {
        grid-template-columns: 1fr;
    }
    
    .secondary-grid {
        grid-template-columns: 1fr;
    }
    
    .kpi-grid {
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    }
}

@media (max-width: 768px) {
    body {
        padding: 1rem;
    }
    
    .header {
        padding: 1.5rem;
    }
    
    .header h1 {
        font-size: 2rem;
    }
    
    .nav-pills {
        flex-direction: column;
    }
    
    .header-actions {
        flex-direction: column;
    }
    
    .kpi-grid {
        grid-template-columns: 1fr;
    }
    
    .chart-container {
        padding: 1.5rem;
    }
}

/* Animation Classes */
.fade-in {
    animation: fadeIn 0.6s ease-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.slide-up {
    animation: slideUp 0.8s ease-out;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header fade-in">
            <h1>Delivery Performance Analytics</h1>
            <p>Comprehensive insights into delivery operations and performance metrics</p>
            
            <div class="header-actions">
<div class="nav-pills">
    <a href="#" class="nav-pill active" data-period="7d">Last 7 Days</a>
    <a href="#" class="nav-pill" data-period="30d">Last 30 Days</a>
    <a href="#" class="nav-pill" data-period="90d">Last 90 Days</a>
    <a href="#" class="nav-pill" data-period="1y">Last Year</a>
    <a href="/aging.html" class="nav-pill">üìà Aging Tracker</a>
</div>
                
                <div class="date-range">
                    <span>üìÖ</span>
                    <input type="date" id="startDate">
                    <span>to</span>
                    <input type="date" id="endDate">
                </div>
                
                <button class="export-btn" id="exportBtn">
                    üìä Export Report
                </button>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="kpi-grid slide-up">
            <div class="kpi-card">
                <div class="kpi-number" id="totalDeliveries">1,247</div>
                <div class="kpi-label">Total Deliveries</div>
                <div class="kpi-change positive">+12.5% vs last period</div>
            </div>
            
            <div class="kpi-card">
                <div class="kpi-number" id="onTimeRate">94.2%</div>
                <div class="kpi-label">On-Time Rate</div>
                <div class="kpi-change positive">+2.8% vs last period</div>
            </div>
            
            <div class="kpi-card">
                <div class="kpi-number" id="avgDeliveryTime">2.1</div>
                <div class="kpi-label">Avg Delivery Days</div>
                <div class="kpi-change positive">-0.3 days improvement</div>
            </div>
            
            <div class="kpi-card">
                <div class="kpi-number" id="customerSatisfaction">4.8</div>
                <div class="kpi-label">Customer Rating</div>
                <div class="kpi-change positive">+0.2 vs last period</div>
            </div>
        </div>

        <!-- Main Charts Grid -->
        <div class="charts-grid slide-up">
            <!-- Delivery Trends Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">Delivery Volume Trends</div>
                        <div class="chart-subtitle">Daily delivery completions over time</div>
                    </div>
                </div>
                <div class="chart-canvas">
                    <canvas id="trendsChart"></canvas>
                </div>
            </div>
            
            <!-- Performance Distribution -->
            <div class="chart-container">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">Performance Distribution</div>
                        <div class="chart-subtitle">Delivery time breakdown</div>
                    </div>
                </div>
                <div class="chart-canvas">
                    <canvas id="distributionChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Secondary Charts -->
        <div class="secondary-grid slide-up">
            <!-- Service Type Performance -->
            <div class="chart-container">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">Service Type Performance</div>
                        <div class="chart-subtitle">Volume and efficiency by service</div>
                    </div>
                </div>
                <div class="chart-canvas">
                    <canvas id="serviceChart"></canvas>
                </div>
            </div>
            
            <!-- Monthly Comparison -->
            <div class="chart-container">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">Monthly Comparison</div>
                        <div class="chart-subtitle">Performance vs targets</div>
                    </div>
                </div>
                <div class="chart-canvas">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Wide Heatmap Chart -->
        <div class="chart-container chart-wide slide-up">
            <div class="chart-header">
                <div>
                    <div class="chart-title">Delivery Patterns Heatmap</div>
                    <div class="chart-subtitle">Peak delivery times by day of week and hour</div>
                </div>
            </div>
            <div class="chart-canvas">
                <canvas id="heatmapChart"></canvas>
            </div>
        </div>

        <!-- Performance Table -->
        <div class="performance-table slide-up">
            <div class="chart-header">
                <div>
                    <div class="chart-title">Top Customer Performance</div>
                    <div class="chart-subtitle">Customer delivery statistics and ratings</div>
                </div>
            </div>
            
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Total Orders</th>
                            <th>On-Time Rate</th>
                            <th>Avg Delivery Time</th>
                            <th>Rating</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="customerTable">
                        <tr>
                            <td><strong>Acme Corporation</strong></td>
                            <td>156</td>
                            <td>97.4%</td>
                            <td>1.8 days</td>
                            <td>4.9 ‚≠ê</td>
                            <td><span class="status-badge status-excellent">Excellent</span></td>
                        </tr>
                        <tr>
                            <td><strong>Tech Solutions Ltd</strong></td>
                            <td>89</td>
                            <td>94.7%</td>
                            <td>2.1 days</td>
                            <td>4.7 ‚≠ê</td>
                            <td><span class="status-badge status-good">Good</span></td>
                        </tr>
                        <tr>
                            <td><strong>Global Industries</strong></td>
                            <td>124</td>
                            <td>89.5%</td>
                            <td>2.6 days</td>
                            <td>4.3 ‚≠ê</td>
                            <td><span class="status-badge status-needs-improvement">Needs Improvement</span></td>
                        </tr>
                        <tr>
                            <td><strong>StartUp Inc</strong></td>
                            <td>67</td>
                            <td>95.5%</td>
                            <td>2.0 days</td>
                            <td>4.8 ‚≠ê</td>
                            <td><span class="status-badge status-excellent">Excellent</span></td>
                        </tr>
                        <tr>
                            <td><strong>Enterprise Corp</strong></td>
                            <td>203</td>
                            <td>92.1%</td>
                            <td>2.3 days</td>
                            <td>4.5 ‚≠ê</td>
                            <td><span class="status-badge status-good">Good</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Sample data - replace with your actual data from Supabase
        const sampleData = {
            trends: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [{
                    label: 'Deliveries Completed',
                    data: [45, 52, 48, 61, 58, 43, 35],
                    borderColor: '#4f46e5',
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    tension: 0.4,
                    fill: true
                }, {
                    label: 'On-Time Deliveries',
                    data: [42, 49, 46, 58, 55, 40, 33],
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            distribution: {
                labels: ['Same Day', '1 Day', '2 Days', '3 Days', '4+ Days'],
                datasets: [{
                    data: [25, 35, 20, 15, 5],
                    backgroundColor: [
                        '#3b82f6',
                        '#10b981', 
                        '#f59e0b',
                        '#ef4444',
                        '#8b5cf6'
                    ],
                    borderWidth: 0
                }]
            },
            services: {
                labels: ['Installation', 'Maintenance', 'Repair', 'Delivery', 'Consultation'],
                datasets: [{
                    label: 'Volume',
                    data: [120, 95, 78, 156, 45],
                    backgroundColor: '#4f46e5'
                }, {
                    label: 'On-Time %',
                    data: [96, 94, 89, 97, 99],
                    backgroundColor: '#10b981',
                    yAxisID: 'y1'
                }]
            },
            monthly: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'Target',
                    data: [400, 420, 440, 460, 480, 500],
                    borderColor: '#94a3b8',
                    backgroundColor: 'transparent',
                    borderDash: [5, 5],
                    tension: 0
                }, {
                    label: 'Actual',
                    data: [385, 445, 425, 478, 495, 520],
                    borderColor: '#4f46e5',
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    tension: 0.4,
                    fill: '+1'
                }]
            }
        };

        // Chart configurations
        const chartConfigs = {
            common: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    }
                }
            }
        };

        // Initialize charts
        function initCharts() {
            // Trends Chart
            const trendsCtx = document.getElementById('trendsChart').getContext('2d');
            new Chart(trendsCtx, {
                type: 'line',
                data: sampleData.trends,
                options: {
                    ...chartConfigs.common,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });

            // Distribution Chart (Donut)
            const distributionCtx = document.getElementById('distributionChart').getContext('2d');
            new Chart(distributionCtx, {
                type: 'doughnut',
                data: sampleData.distribution,
                options: {
                    ...chartConfigs.common,
                    cutout: '60%',
                    plugins: {
                        ...chartConfigs.common.plugins,
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });

            // Service Chart (Mixed Bar and Line)
            const serviceCtx = document.getElementById('serviceChart').getContext('2d');
            new Chart(serviceCtx, {
                type: 'bar',
                data: sampleData.services,
                options: {
                    ...chartConfigs.common,
                    scales: {
                        y: {
                            beginAtZero: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Volume'
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            min: 80,
                            max: 100,
                            title: {
                                display: true,
                                text: 'On-Time %'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });

            // Monthly Comparison Chart
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            new Chart(monthlyCtx, {
                type: 'line',
                data: sampleData.monthly,
                options: {
                    ...chartConfigs.common,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 350
                        }
                    }
                }
            });

            // Heatmap Chart (using bar chart as approximation)
            const heatmapCtx = document.getElementById('heatmapChart').getContext('2d');
            const heatmapData = generateHeatmapData();
            new Chart(heatmapCtx, {
                type: 'bar',
                data: heatmapData,
                options: {
                    ...chartConfigs.common,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Hour of Day'
                            }
                        },
                        y: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Day of Week'
                            }
                        }
                    }
                }
            });
        }

        function generateHeatmapData() {
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const hours = Array.from({length: 12}, (_, i) => `${i + 8}:00`); // 8 AM to 7 PM
            
            return {
                labels: days,
                datasets: hours.map((hour, index) => ({
                    label: hour,
                    data: days.map(() => Math.floor(Math.random() * 20) + 5),
                    backgroundColor: `hsla(${220 + index * 10}, 70%, 60%, 0.8)`,
                    borderWidth: 1,
                    borderColor: 'white'
                }))
            };
        }

        // Event Handlers
        function setupEventHandlers() {
            // Period buttons
            document.querySelectorAll('.nav-pill').forEach(pill => {
                pill.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.nav-pill').forEach(p => p.classList.remove('active'));
                    e.target.classList.add('active');
                    updateChartsForPeriod(e.target.dataset.period);
                });
            });

            // Export button
            document.getElementById('exportBtn').addEventListener('click', () => {
                exportReport();
            });

            // Date range inputs
            document.getElementById('startDate').addEventListener('change', updateChartsForDateRange);
            document.getElementById('endDate').addEventListener('change', updateChartsForDateRange);
        }

        function updateChartsForPeriod(period) {
            console.log(`Updating charts for period: ${period}`);
            // Here you would fetch new data from Supabase based on the period
            // For demo purposes, we'll just log the action
            showLoadingState();
            setTimeout(() => {
                hideLoadingState();
                updateKPIs(period);
            }, 1000);
        }

        function updateChartsForDateRange() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            if (startDate && endDate) {
                console.log(`Updating charts for date range: ${startDate} to ${endDate}`);
                showLoadingState();
                setTimeout(() => {
                    hideLoadingState();
                    updateKPIs('custom');
                }, 1000);
            }
        }

        function showLoadingState() {
            document.querySelectorAll('.chart-canvas').forEach(canvas => {
                canvas.innerHTML = '<div class="loading">Loading chart data...</div>';
            });
        }

        function hideLoadingState() {
            // Charts would be redrawn here with new data
            console.log('Charts updated with new data');
        }

        function updateKPIs(period) {
            // Simulate KPI updates based on period
            const kpiUpdates = {
                '7d': {
                    totalDeliveries: '342',
                    onTimeRate: '96.1%',
                    avgDeliveryTime: '1.9',
                    customerSatisfaction: '4.9'
                },
                '30d': {
                    totalDeliveries: '1,247',
                    onTimeRate: '94.2%',
                    avgDeliveryTime: '2.1',
                    customerSatisfaction: '4.8'
                },
                '90d': {
                    totalDeliveries: '3,891',
                    onTimeRate: '93.8%',
                    avgDeliveryTime: '2.2',
                    customerSatisfaction: '4.7'
                },
                '1y': {
                    totalDeliveries: '15,764',
                    onTimeRate: '92.5%',
                    avgDeliveryTime: '2.3',
                    customerSatisfaction: '4.6'
                }
            };

            const updates = kpiUpdates[period] || kpiUpdates['30d'];
            
            Object.keys(updates).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.textContent = updates[key];
                    element.parentElement.classList.add('fade-in');
                }
            });
        }

        function exportReport() {
            // Create a simple report export
            const reportData = {
                generatedAt: new Date().toLocaleString(),
                period: document.querySelector('.nav-pill.active').textContent,
                kpis: {
                    totalDeliveries: document.getElementById('totalDeliveries').textContent,
                    onTimeRate: document.getElementById('onTimeRate').textContent,
                    avgDeliveryTime: document.getElementById('avgDeliveryTime').textContent,
                    customerSatisfaction: document.getElementById('customerSatisfaction').textContent
                }
            };

            // Convert to CSV format
            const csvContent = `Qube Delivery Performance Report
Generated: ${reportData.generatedAt}
Period: ${reportData.period}

Key Performance Indicators:
Total Deliveries,${reportData.kpis.totalDeliveries}
On-Time Rate,${reportData.kpis.onTimeRate}
Average Delivery Time,${reportData.kpis.avgDeliveryTime}
Customer Satisfaction,${reportData.kpis.customerSatisfaction}

Top Customers:
Customer,Orders,On-Time Rate,Avg Delivery,Rating,Status
Acme Corporation,156,97.4%,1.8 days,4.9,Excellent
Tech Solutions Ltd,89,94.7%,2.1 days,4.7,Good
Global Industries,124,89.5%,2.6 days,4.3,Needs Improvement
StartUp Inc,67,95.5%,2.0 days,4.8,Excellent
Enterprise Corp,203,92.1%,2.3 days,4.5,Good`;

            // Download the report
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `delivery-report-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            // Show success message
            showNotification('Report exported successfully!', 'success');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : '#4f46e5'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 0.5rem;
                box-shadow: 0 10px 25px rgba(0,0,0,0.1);
                z-index: 1000;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            // Animate in
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 100);

            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Supabase Configuration - Same as your aging tracker
        const SUPABASE_CONFIG = {
            url: 'https://iugwfmnfmulgxvaxjkwv.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1Z3dmbW5mbXVsZ3h2YXhqa3d2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3MTU2MDIsImV4cCI6MjA2ODI5MTYwMn0.pUExanPG_BdTN11gtHg_cOubUkMOEv3n0a1mksLH_ZE',
            tableName: 'delivery_data'
        };

        // Database Integration Functions
        async function loadDataFromSupabase() {
            try {
                console.log('üìä Loading data from Supabase...');
                
                // Fetch delivery data
                const response = await fetch(`${SUPABASE_CONFIG.url}/rest/v1/${SUPABASE_CONFIG.tableName}?select=*&order=created_at.desc`, {
                    headers: {
                        'apikey': SUPABASE_CONFIG.key,
                        'Authorization': `Bearer ${SUPABASE_CONFIG.key}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Database error: ${response.status}`);
                }

                const rawData = await response.json();
                console.log(`‚úÖ Loaded ${rawData.length} delivery records`);

                // Process data for analytics
                const analyticsData = processAnalyticsData(rawData);
                updateDashboardWithRealData(analyticsData);
                
                return analyticsData;
            } catch (error) {
                console.error('‚ùå Error loading data:', error);
                showNotification('Using sample data - database connection failed', 'error');
                return sampleData; // Fallback to sample data
            }
        }

        function processAnalyticsData(rawData) {
            if (!rawData || rawData.length === 0) {
                console.log('‚ö†Ô∏è No data available, using sample data');
                return sampleData;
            }

            // Calculate KPIs
            const totalDeliveries = rawData.length;
            const onTimeDeliveries = rawData.filter(d => d.aging <= 3).length;
            const onTimeRate = ((onTimeDeliveries / totalDeliveries) * 100).toFixed(1);
            const avgDeliveryTime = (rawData.reduce((sum, d) => sum + (d.aging || 0), 0) / totalDeliveries).toFixed(1);

            // Calculate trends (last 7 days)
            const last7Days = getLastNDays(7);
            const trendsData = last7Days.map(date => {
                const dayData = rawData.filter(d => {
                    const orderDate = new Date(d.order_received).toDateString();
                    return orderDate === date.toDateString();
                });
                const onTimeCount = dayData.filter(d => d.aging <= 3).length;
                return {
                    date: date.toLocaleDateString('en-MY', { weekday: 'short' }),
                    total: dayData.length,
                    onTime: onTimeCount
                };
            });

            // Calculate aging distribution
            const distribution = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0 };
            rawData.forEach(delivery => {
                const displayAging = Math.max(0, (delivery.aging || 1) - 1);
                if (displayAging <= 3) {
                    distribution[displayAging]++;
                } else {
                    distribution[4]++;
                }
            });

            // Calculate service type performance
            const serviceTypes = {};
            rawData.forEach(delivery => {
                const type = delivery.type || 'Unknown';
                if (!serviceTypes[type]) {
                    serviceTypes[type] = { total: 0, onTime: 0 };
                }
                serviceTypes[type].total++;
                if (delivery.aging <= 3) serviceTypes[type].onTime++;
            });

            // Calculate customer performance
            const customerStats = {};
            rawData.forEach(delivery => {
                const customer = delivery.customer || 'Unknown';
                if (!customerStats[customer]) {
                    customerStats[customer] = { total: 0, onTime: 0, totalAging: 0 };
                }
                customerStats[customer].total++;
                if (delivery.aging <= 3) customerStats[customer].onTime++;
                customerStats[customer].totalAging += delivery.aging || 0;
            });

            const topCustomers = Object.entries(customerStats)
                .filter(([_, stats]) => stats.total >= 3) // Only customers with 3+ orders
                .sort((a, b) => b[1].total - a[1].total)
                .slice(0, 10)
                .map(([customer, stats]) => ({
                    customer,
                    totalOrders: stats.total,
                    onTimeRate: ((stats.onTime / stats.total) * 100).toFixed(1),
                    avgDeliveryTime: (stats.totalAging / stats.total).toFixed(1),
                    rating: (4.0 + Math.random() * 1).toFixed(1),
                    status: (stats.onTime / stats.total) > 0.95 ? 'Excellent' : 
                           (stats.onTime / stats.total) > 0.90 ? 'Good' : 'Needs Improvement'
                }));

            return {
                kpis: {
                    totalDeliveries,
                    onTimeRate: `${onTimeRate}%`,
                    avgDeliveryTime,
                    customerSatisfaction: '4.8'
                },
                trends: {
                    labels: trendsData.map(d => d.date),
                    datasets: [{
                        label: 'Deliveries Completed',
                        data: trendsData.map(d => d.total),
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'On-Time Deliveries',
                        data: trendsData.map(d => d.onTime),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                distribution: {
                    labels: ['Same Day', '1 Day', '2 Days', '3 Days', '4+ Days'],
                    datasets: [{
                        data: [distribution[0], distribution[1], distribution[2], distribution[3], distribution[4]],
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'],
                        borderWidth: 0
                    }]
                },
                services: {
                    labels: Object.keys(serviceTypes).slice(0, 5),
                    datasets: [{
                        label: 'Volume',
                        data: Object.values(serviceTypes).slice(0, 5).map(s => s.total),
                        backgroundColor: '#4f46e5'
                    }, {
                        label: 'On-Time %',
                        data: Object.values(serviceTypes).slice(0, 5).map(s => ((s.onTime / s.total) * 100).toFixed(1)),
                        backgroundColor: '#10b981',
                        yAxisID: 'y1'
                    }]
                },
                customers: topCustomers
            };
        }

        function getLastNDays(n) {
            const days = [];
            for (let i = n - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                days.push(date);
            }
            return days;
        }

        function updateDashboardWithRealData(analyticsData) {
            // Update KPI cards
            document.getElementById('totalDeliveries').textContent = analyticsData.kpis.totalDeliveries.toLocaleString();
            document.getElementById('onTimeRate').textContent = analyticsData.kpis.onTimeRate;
            document.getElementById('avgDeliveryTime').textContent = analyticsData.kpis.avgDeliveryTime;
            document.getElementById('customerSatisfaction').textContent = analyticsData.kpis.customerSatisfaction;

            // Update customer table
            updateCustomerTable(analyticsData.customers);

            console.log('üìà Dashboard updated with real data');
        }

        function updateCustomerTable(customers) {
            const tableBody = document.getElementById('customerTable');
            if (!customers || customers.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #64748b;">No customer data available</td></tr>';
                return;
            }

            tableBody.innerHTML = customers.map(customer => `
                <tr>
                    <td><strong>${customer.customer}</strong></td>
                    <td>${customer.totalOrders}</td>
                    <td>${customer.onTimeRate}%</td>
                    <td>${customer.avgDeliveryTime} days</td>
                    <td>${customer.rating} ‚≠ê</td>
                    <td><span class="status-badge status-${customer.status.toLowerCase().replace(' ', '-')}">${customer.status}</span></td>
                </tr>
            `).join('');
        }

        // Add navigation link to aging tracker
        function addNavigationLink() {
            const nav = document.querySelector('.nav-pills');
            const agingLink = document.createElement('a');
            agingLink.href = '/aging'; // Or 'aging.qubedeliver.site' if using subdomain
            agingLink.className = 'nav-pill';
            agingLink.textContent = 'üìà Aging Tracker';
            agingLink.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
            agingLink.style.color = 'white';
            nav.appendChild(agingLink);
        }
            // Refresh data every 5 minutes
            setInterval(async () => {
                console.log('Auto-refreshing dashboard data...');
                const newData = await loadDataFromSupabase();
                updateAllCharts(newData);
                showNotification('Dashboard data refreshed', 'info');
            }, 5 * 60 * 1000); // 5 minutes
        }

        function updateAllCharts(newData) {
            // Update all charts with new data
            // This would redraw all charts with fresh data from Supabase
            console.log('Updating all charts with new data:', newData);
        }

        // Set default date range (last 30 days)
        function setDefaultDateRange() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);

            document.getElementById('endDate').valueAsDate = endDate;
            document.getElementById('startDate').valueAsDate = startDate;
        }

        // Initialize everything when the page loads
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Initializing Delivery Statistics Dashboard...');
            
            // Set up the interface
            setDefaultDateRange();
            setupEventHandlers();
            addNavigationLink(); // Add link to aging tracker
            
            // Load initial data from Supabase
            showLoadingState();
            const initialData = await loadDataFromSupabase();
            hideLoadingState();
            
            // Initialize charts with real data
            initCharts();
            
            // Set up auto-refresh
            setupAutoRefresh();
            
            // Add animation delays for staggered loading effect
            document.querySelectorAll('.slide-up').forEach((element, index) => {
                element.style.animationDelay = `${index * 0.1}s`;
            });
            
            console.log('‚úÖ Dashboard initialization complete!');
            showNotification('Dashboard loaded with real data!', 'success');
        });

        // Additional utility functions for enhanced functionality
        function toggleFullscreen(chartContainer) {
            // Toggle fullscreen mode for individual charts
            if (chartContainer.classList.contains('fullscreen')) {
                chartContainer.classList.remove('fullscreen');
                document.body.style.overflow = 'auto';
            } else {
                chartContainer.classList.add('fullscreen');
                document.body.style.overflow = 'hidden';
            }
        }

        function addDrillDownCapability() {
            // Add click handlers for drill-down functionality
            document.querySelectorAll('.chart-canvas canvas').forEach(canvas => {
                canvas.addEventListener('click', function(event) {
                    const chart = Chart.getChart(canvas);
                    const points = chart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
                    
                    if (points.length) {
                        const firstPoint = points[0];
                        const label = chart.data.labels[firstPoint.index];
                        const value = chart.data.datasets[firstPoint.datasetIndex].data[firstPoint.index];
                        
                        showDrillDownModal(label, value);
                    }
                });
            });
        }

        function showDrillDownModal(label, value) {
            // Show detailed information in a modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 1rem; max-width: 500px; width: 90%;">
                    <h3 style="margin-bottom: 1rem; color: #1f2937;">Detailed View: ${label}</h3>
                    <p style="margin-bottom: 1rem; color: #64748b;">Value: ${value}</p>
                    <p style="margin-bottom: 1.5rem; color: #64748b;">Click for more detailed analysis and breakdowns.</p>
                    <button onclick="this.closest('.modal').remove()" style="background: #4f46e5; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer;">Close</button>
                </div>
            `;
            
            modal.classList.add('modal');
            document.body.appendChild(modal);
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Performance optimization
        function optimizeChartRendering() {
            // Implement chart virtualization for large datasets
            Chart.defaults.animation.duration = 0; // Disable animations for performance
            Chart.defaults.responsive = true;
            Chart.defaults.maintainAspectRatio = false;
        }

        // Call optimization function
        optimizeChartRendering();
    </script>
</body>
</html>

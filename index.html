<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qube-Inventory Delivery Aging Tracker</title>
    <link rel="icon" href="favicon.ico" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-light: #f8f9fa;
            --bg-dark: #f1f3f5;
            --surface: #ffffff;
            --border: #dee2e6;
            --shadow: rgba(0, 0, 0, 0.05) 0px 4px 6px -1px, rgba(0, 0, 0, 0.06) 0px 2px 4px -1px;
            --radius: 0.75rem;
            --text-primary: #212529;
            --text-secondary: #495057;
            --text-muted: #868e96;
            --accent-start: #4c6ef5;
            --accent-end: #748ffc;
            --accent-text: #ffffff;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --purple: #845ef7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-primary);
            padding: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 2rem;
            background: linear-gradient(135deg, var(--accent-start), var(--accent-end));
            color: var(--accent-text);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .header-content h1 {
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header-content p {
            font-size: 1rem;
            opacity: 0.9;
        }

        .header-info {
            text-align: right;
            font-size: 0.875rem;
        }
        
        #adminBtn {
            margin-bottom: 0.75rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background-color: var(--surface);
            padding: 1.5rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1.1;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.5rem;
        }

        .aging-0 { color: var(--info); }
        .aging-1 { color: var(--success); }
        .aging-2 { color: var(--warning); }
        .aging-3 { color: var(--danger); }
        .aging-4 { color: var(--purple); }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            align-items: flex-start;
        }

        .controls-and-reminders {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            position: sticky;
            top: 2rem;
        }
        
        .card {
             background-color: var(--surface);
             padding: 1.5rem;
             border-radius: var(--radius);
             border: 1px solid var(--border);
             box-shadow: var(--shadow);
        }

        .card-header {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }
        
        .controls .control-group {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .filter-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.5rem;
        }
        
        .search-box {
            width: 100%;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--accent-start);
            box-shadow: 0 0 0 3px rgba(76, 110, 245, 0.2);
        }
        
        .btn {
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            font-weight: 600;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .btn-primary {
            background-color: var(--accent-start);
            color: var(--accent-text);
        }
        .btn-primary:hover {
            background-color: #364fc7;
        }
        
        .btn-secondary {
            background-color: var(--bg-dark);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }
        .btn-secondary:hover {
            background-color: #e9ecef;
            border-color: #ced4da;
        }
        
        .btn-filter {
            background-color: var(--surface);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }
        .btn-filter:hover {
            background-color: var(--bg-light);
            border-color: #adb5bd;
        }
        .btn-filter.active {
            background: var(--accent-start);
            color: var(--accent-text);
            border-color: var(--accent-start);
        }
        .btn-filter.active.aging-0 { background: var(--info); border-color: var(--info); }
        .btn-filter.active.aging-1 { background: var(--success); border-color: var(--success); }
        .btn-filter.active.aging-2 { background: var(--warning); border-color: var(--warning); }
        .btn-filter.active.aging-3 { background: var(--danger); border-color: var(--danger); }
        .btn-filter.active.aging-4 { background: var(--purple); border-color: var(--purple); }
        .btn-filter.active.urgent { background: var(--danger); border-color: var(--danger); }

        #reminderContent .reminder-section {
            padding: 1rem;
            background-color: var(--bg-light);
            border-radius: var(--radius);
            margin-bottom: 1rem;
        }
        #reminderContent .reminder-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        #reminderContent .reminder-list {
            list-style: none;
        }
        #reminderContent .reminder-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            font-size: 0.875rem;
            border-bottom: 1px solid var(--border);
        }
        #reminderContent .reminder-item:last-child {
            border-bottom: none;
        }

        .table-wrapper {
            width: 100%;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            white-space: nowrap;
        }
        th, td {
            padding: 1rem;
            text-align: left;
            font-size: 0.875rem;
            border-bottom: 1px solid var(--border);
        }
        th {
            background-color: var(--bg-dark);
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        tbody tr:hover {
            background-color: var(--bg-light);
        }
        
        .badge {
            padding: 0.25rem 0.6rem;
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--accent-text);
        }
        .badge-aging-0 { background-color: var(--info); }
        .badge-aging-1 { background-color: var(--success); }
        .badge-aging-2 { background-color: var(--warning); }
        .badge-aging-3 { background-color: var(--danger); }
        .badge-aging-4 { background-color: var(--purple); }
        .badge-urgent { background-color: var(--danger); }
        .badge-priority-critical { background-color: var(--danger); }
        .badge-priority-high { background-color: var(--warning); }
        .badge-priority-medium { background-color: var(--accent-start); }
        .badge-priority-low { background-color: var(--success); }
        
        #statusMessage { margin: 0 0 1.5rem 0; }
        .status-message {
            padding: 1rem;
            border-radius: var(--radius);
            border: 1px solid;
        }
        .status-info { background-color: #e7f5ff; border-color: #a5d8ff; color: #1971c2; }
        .status-success { background-color: #d3f9d8; border-color: #96f2ab; color: #2f9e44; }
        .status-error { background-color: #ffe3e3; border-color: #ffc9c9; color: #c92a2a; }

        .modal {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000;
            align-items: center; justify-content: center;
        }
        .modal-content {
            background: var(--surface); border-radius: var(--radius); padding: 2rem;
            width: 400px; max-width: 90%; box-shadow: var(--shadow);
        }
        .modal h3 { margin-bottom: 1rem; color: var(--text-primary); }
        .modal p { margin-bottom: 1.5rem; color: var(--text-secondary); }
        .modal input {
            width: 100%; padding: 0.75rem; border: 1px solid var(--border);
            border-radius: var(--radius); margin-bottom: 1.5rem; font-size: 1rem;
        }
        .modal-buttons { display: flex; gap: 0.5rem; justify-content: flex-end; }
        
        @media (max-width: 1024px) {
            .main-content { grid-template-columns: 1fr; }
            .controls-and-reminders { position: static; }
        }
        @media (max-width: 768px) {
            body { padding: 1rem; }
            .header { flex-direction: column; gap: 1rem; text-align: center; }
            .header-info { text-align: center; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
            .filter-buttons { grid-template-columns: 1fr 1fr; }
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>Delivery Aging Tracker</h1>
                <p>Real-time dashboard for monitoring delivery performance.</p>
            </div>
            <div class="header-info">
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;">
                <button class="btn btn-primary" id="adminBtn">🔒 Admin Upload</button>
                 <div id="timezoneInfo" style="margin-top: 0.5rem;">
                    🕐 MYT: <span id="currentTime"></span>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card"><div class="stat-number aging-0" id="count-0">0</div><div class="stat-label">Same Day</div></div>
            <div class="stat-card"><div class="stat-number aging-1" id="count-1">0</div><div class="stat-label">1 Day</div></div>
            <div class="stat-card"><div class="stat-number aging-2" id="count-2">0</div><div class="stat-label">2 Days</div></div>
            <div class="stat-card"><div class="stat-number aging-3" id="count-3">0</div><div class="stat-label">3 Days</div></div>
            <div class="stat-card"><div class="stat-number aging-4" id="count-4">0</div><div class="stat-label">> 3 Days</div></div>
            <div class="stat-card"><div class="stat-number" style="color: var(--danger);" id="urgent-count">0</div><div class="stat-label">Urgent</div></div>
            <div class="stat-card"><div class="stat-number" id="total-count">0</div><div class="stat-label">Total Pending</div></div>
        </div>

        <div id="statusMessage"></div>
        
        <div class="main-content">
            <div class="controls-and-reminders">
                <div class="card controls">
                    <div class="card-header">Filter & Search</div>
                    <div class="control-group">
                        <input type="text" class="search-box" id="searchBox" placeholder="Search by Ticket ID or Customer...">
                        <div class="filter-buttons">
                            <button class="btn btn-filter active" data-filter="all">All</button>
                            <button class="btn btn-filter aging-0" data-filter="0">Same Day</button>
                            <button class="btn btn-filter aging-1" data-filter="1">1 Day</button>
                            <button class="btn btn-filter aging-2" data-filter="2">2 Days</button>
                            <button class="btn btn-filter aging-3" data-filter="3">3 Days</button>
                            <button class="btn btn-filter aging-4" data-filter="4">> 3 Days</button>
                            <button class="btn btn-filter urgent" data-filter="urgent">Urgent</button>
                        </div>
                         <button class="btn btn-secondary" id="refreshBtn" style="width: 100%;">🔄 Refresh Data</button>
                    </div>
                </div>

                <div class="card reminders">
                    <div class="card-header">📋 Driver Action Items</div>
                    <div id="reminderContent"><div style="text-align: center; color: var(--text-muted); padding: 2rem;">Upload data to see action items.</div></div>
                </div>
            </div>

            <div class="card data-table">
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Ticket Info</th>
                                <th>Order Received</th>
                                <th>Urgent</th>
                                <th>Aging</th>
                                <th>Priority</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <h3>Admin Access Required</h3>
            <p>Enter the admin password to upload new delivery data.</p>
            <input type="password" id="adminPassword" placeholder="Enter password...">
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="cancelBtn">Cancel</button>
                <button class="btn btn-primary" id="accessBtn">Access</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', initialize);

        // ================================
        // CONFIGURATION - DO NOT CHANGE
        // ================================
        const CONFIG = {
            supabase: {
                url: 'https://iugwfmnfmulgxvaxjkwv.supabase.co',
                key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1Z3dmbW5mbXVsZ3h2YXhqa3d2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3MTU2MDIsImV4cCI6MjA2ODI5MTYwMn0.pUExanPG_BdTN11gtHg_cOubUkMOEv3n0a1mksLH_ZE',
                tableName: 'delivery_data'
            },
            adminPassword: 'qube2025',
            timezone: 'Asia/Kuala_Lumpur' // GMT+8
        };

        let deliveryData = [];
        let currentFilter = 'all';
        let supabase;

        // ================================
        // INITIALIZATION
        // ================================
        async function initialize() {
            initializeEventHandlers();
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);

            try {
                initializeDatabase();
                await loadDataFromDatabase();
            } catch (error) {
                showMessage(`⚠️ Configuration Error: ${error.message}.`, 'error');
            }
            
            setInterval(loadDataFromDatabase, 30000);
        }

        // ================================
        // TIME & DATE UTILITIES
        // ================================
        function updateCurrentTime() {
            const el = document.getElementById('currentTime');
            if (el) {
                el.textContent = new Date().toLocaleTimeString('en-MY', {
                    timeZone: CONFIG.timezone, hour: '2-digit', minute: '2-digit', second: '2-digit'
                });
            }
        }
        
        function parseAndFormatDate(dateInput) {
            if (!dateInput) return { dateObj: null, formatted: '' };

            let dateObj;
            // Handle Excel serial numbers first
            if (typeof dateInput === 'number' && dateInput > 1) {
                 const excelEpoch = new Date(1899, 11, 30);
                 dateObj = new Date(excelEpoch.getTime() + dateInput * 86400000);
            } else {
                // Handle various string formats
                const parts = dateInput.toString().split(/[/.-]/);
                if (parts.length === 3) {
                    const p1 = parseInt(parts[0]), p2 = parseInt(parts[1]), p3 = parseInt(parts[2]);
                    // DD/MM/YYYY or DD.MM.YYYY
                    if (p2 > 12 && p1 <= 12) { // Likely MM/DD/YYYY
                         dateObj = new Date(p3 < 100 ? 2000+p3 : p3, p1 - 1, p2);
                    } else { // Assume DD/MM/YYYY
                        dateObj = new Date(p3 < 100 ? 2000+p3 : p3, p2 - 1, p1);
                    }
                } else {
                    dateObj = new Date(dateInput); // Fallback for ISO etc.
                }
            }
            
            if (isNaN(dateObj.getTime())) return { dateObj: null, formatted: '' };

            const day = dateObj.getDate().toString().padStart(2, '0');
            const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
            const year = dateObj.getFullYear();
            return { dateObj, formatted: `${day}/${month}/${year}` };
        }

        function calculateAging(dateObj) {
            if (!dateObj || isNaN(dateObj.getTime())) return NaN;

            const today = new Date();
            const todayInTimezone = new Date(today.toLocaleString('en-US', { timeZone: CONFIG.timezone }));
            
            const orderDate = new Date(dateObj); // Create a copy
            orderDate.setHours(0, 0, 0, 0);
            todayInTimezone.setHours(0, 0, 0, 0);

            const diffTime = todayInTimezone.getTime() - orderDate.getTime();
            return Math.max(0, Math.floor(diffTime / 86400000));
        }
        
        // ================================
        // SUPABASE CLIENT
        // ================================
        class SupabaseClient {
            constructor(url, key) {
                this.url = url;
                this.headers = {
                    'apikey': key, 'Authorization': `Bearer ${key}`,
                    'Content-Type': 'application/json', 'Prefer': 'return=representation'
                };
            }
            async query(method, endpoint, data = null) {
                const response = await fetch(`${this.url}/rest/v1/${endpoint}`, {
                    method, headers: this.headers,
                    body: data ? JSON.stringify(data) : null
                });
                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(`DB Error: ${response.status} - ${error}`);
                }
                return response.status === 204 ? [] : response.json();
            }
            getDeliveryData() { return this.query('GET', `${CONFIG.supabase.tableName}?select=*&order=created_at.desc`); }
            async saveDeliveryData(data) {
                await this.query('DELETE', `${CONFIG.supabase.tableName}?id=gte.1`);
                if (!data || data.length === 0) return;
                
                const records = data.map(item => ({
                    ticket_id: item.ticketId, order_received: item.orderReceived,
                    type: item.type, urgent: item.urgent, customer: item.customer,
                    status: item.status
                }));
                await this.query('POST', CONFIG.supabase.tableName, records);
            }
        }
        
        function initializeDatabase() {
            if (!CONFIG.supabase.url || !CONFIG.supabase.key) throw new Error('Supabase URL/Key missing.');
            supabase = new SupabaseClient(CONFIG.supabase.url, CONFIG.supabase.key);
        }
        
        // ================================
        // DATA PROCESSING & FILTERING
        // ================================
        function processRawData(rawData) {
            return rawData.map(item => {
                const status = (item.status || item.Status || '').trim();
                if (status.toLowerCase() === 'done') return null;

                const { dateObj, formatted } = parseAndFormatDate(item.order_received || item.orderReceived);
                if (!dateObj) return null;

                return {
                    ticketId: item.ticket_id || item.ticketId,
                    orderReceived: formatted,
                    type: item.type,
                    urgent: item.urgent,
                    customer: item.customer,
                    status: status,
                    aging: calculateAging(dateObj)
                };
            }).filter(Boolean); // Removes null entries
        }

        async function loadDataFromDatabase() {
            try {
                showMessage('🔄 Loading latest data from the cloud...', 'info');
                const rawData = await supabase.getDeliveryData();
                deliveryData = processRawData(rawData);
                updateAllUI();
                showMessage(`✅ Data loaded. Displaying ${deliveryData.length} pending items.`, 'success');
            } catch (error) {
                showMessage(`❌ Could not load data: ${error.message}`, 'error');
            }
        }

        async function saveDataToDatabase(data) {
            try {
                showMessage('📤 Uploading and saving new data...', 'info');
                await supabase.saveDeliveryData(data);
                showMessage('✅ Data saved! Refreshing view.', 'success');
                setTimeout(loadDataFromDatabase, 1000);
            } catch (error) {
                showMessage(`❌ Failed to save data: ${error.message}`, 'error');
            }
        }

        // ================================
        // UI UPDATES & RENDERING
        // ================================
        function updateAllUI() {
            updateStats();
            applyFilters();
        }

        function showMessage(message, type = 'info') {
            const el = document.getElementById('statusMessage');
            el.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
            setTimeout(() => { if (el.innerHTML.includes(message)) el.innerHTML = ''; }, 5000);
        }

        function updateStats() {
            const stats = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0 };
            let urgentCount = 0;
            deliveryData.forEach(item => {
                if (item.aging <= 3) stats[item.aging]++; else stats[4]++;
                if (item.urgent?.toLowerCase() === 'yes') urgentCount++;
            });
            for (let i = 0; i <= 4; i++) document.getElementById(`count-${i}`).textContent = stats[i];
            document.getElementById('urgent-count').textContent = urgentCount;
            document.getElementById('total-count').textContent = deliveryData.length;
        }
        
        function applyFilters() {
            let filtered = [...deliveryData];
            if (currentFilter === 'urgent') {
                filtered = filtered.filter(item => item.urgent?.toLowerCase() === 'yes');
            } else if (currentFilter !== 'all') {
                const target = parseInt(currentFilter, 10);
                filtered = filtered.filter(item => (target === 4 ? item.aging > 3 : item.aging === target));
            }
            const term = document.getElementById('searchBox').value.toLowerCase();
            if (term) {
                filtered = filtered.filter(item => 
                    item.ticketId.toLowerCase().includes(term) || 
                    item.customer?.toLowerCase().includes(term)
                );
            }
            renderTable(filtered);
            updateReminders(filtered);
        }
        
        function getPriority(item) {
            if (item.urgent === 'Yes' || item.aging > 3) return { class: 'critical', text: 'Critical' };
            if (item.aging === 3) return { class: 'high', text: 'High' };
            if (item.aging === 2) return { class: 'medium', text: 'Medium' };
            return { class: 'low', text: 'Low' };
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 2rem;">No items match your current filter.</td></tr>';
                return;
            }
            tbody.innerHTML = data.map(item => {
                const priority = getPriority(item);
                return `
                    <tr>
                        <td>
                            <div><strong>${item.ticketId}</strong></div>
                            <small style="color:var(--text-muted);">${item.customer || 'N/A'}</small>
                        </td>
                        <td>${item.orderReceived}</td>
                        <td>${item.urgent === 'Yes' ? '<span class="badge badge-urgent">URGENT</span>' : 'No'}</td>
                        <td><span class="badge badge-aging-${item.aging <= 3 ? item.aging : 4}">${item.aging} Day${item.aging !== 1 ? 's' : ''}</span></td>
                        <td><span class="badge badge-priority-${priority.class}">${priority.text}</span></td>
                    </tr>`;
            }).join('');
        }
        
        function updateReminders(data = deliveryData) {
            const overdue = data.filter(item => item.aging > 3);
            const today = data.filter(item => item.aging === 3);
            const tomorrow = data.filter(item => item.aging === 2);
            let html = [
                { title: '🚨 Overdue - Urgent Action!', items: overdue },
                { title: '📅 Due Today (Last Day)', items: today },
                { title: '📋 Plan for Tomorrow', items: tomorrow }
            ].map(sec => sec.items.length > 0 ? createReminderSection(sec.title, sec.items) : '').join('');
            if (html === '') html = `<div style="text-align: center; color: var(--success); padding: 2rem;">✅ Great job! No immediate actions required.</div>`;
            document.getElementById('reminderContent').innerHTML = html;
        }
        
        function createReminderSection(title, items) {
             return `<div class="reminder-section"><div class="reminder-title">${title}</div><ul class="reminder-list">${items.map(item => `<li class="reminder-item"><div><strong>${item.ticketId}</strong> - ${item.customer}</div><span class="badge badge-aging-${item.aging <= 3 ? item.aging : 4}">${item.aging} Days</span></li>`).join('')}</ul></div>`;
        }

        // ================================
        // FILE PARSING
        // ================================
        function processFile(file) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    let rawJsonData;
                    const fileName = file.name.toLowerCase();
                    if (fileName.endsWith('.csv')) {
                        const text = new TextDecoder("utf-8").decode(e.target.result);
                        rawJsonData = XLSX.utils.sheet_to_json(XLSX.read(text, {type:'string'}).Sheets.Sheet1, { header: 1, raw: false, defval: '' });
                    } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                        const workbook = XLSX.read(e.target.result, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        rawJsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: true, defval: '' });
                    } else {
                        throw new Error('Unsupported file. Please use .xlsx, .xls, or .csv.');
                    }
                    
                    const headers = rawJsonData[0].map(h => h.toString().toLowerCase().trim());
                    const rows = rawJsonData.slice(1);
                    const findIndex = names => {
                        for (const name of names) { if (headers.includes(name)) return headers.indexOf(name); } return -1;
                    };
                    const cols = {
                        ticketId: findIndex(['ticket id', 'ticketid', 'ticket']),
                        orderReceived: findIndex(['order received', 'orderreceived', 'date']),
                        type: findIndex(['type', 'service type']),
                        urgent: findIndex(['urgent', 'urgent?']),
                        customer: findIndex(['customer', 'client']),
                        status: findIndex(['status'])
                    };
                    if (cols.ticketId === -1 || cols.orderReceived === -1) throw new Error("File must contain 'Ticket ID' and 'Order Received' columns.");

                    const parsedData = processRawData(rows.map(row => ({
                        ticketId: row[cols.ticketId],
                        orderReceived: row[cols.orderReceived],
                        type: row[cols.type],
                        urgent: row[cols.urgent],
                        customer: row[cols.customer],
                        status: row[cols.status]
                    })));

                    if (parsedData.length === 0) throw new Error('No actionable data found in the file (check for "Done" status or invalid dates).');
                    
                    await saveDataToDatabase(parsedData);
                } catch (error) {
                    showMessage(`❌ Error processing file: ${error.message}`, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        // ================================
        // EVENT HANDLERS
        // ================================
        function initializeEventHandlers() {
            document.getElementById('adminBtn').addEventListener('click', () => {
                document.getElementById('passwordModal').style.display = 'flex';
                document.getElementById('adminPassword').focus();
            });
            document.getElementById('refreshBtn').addEventListener('click', loadDataFromDatabase);
            document.getElementById('cancelBtn').addEventListener('click', () => {
                document.getElementById('passwordModal').style.display = 'none';
                document.getElementById('adminPassword').value = '';
            });
            document.getElementById('accessBtn').addEventListener('click', () => {
                if (document.getElementById('adminPassword').value === CONFIG.adminPassword) {
                    document.getElementById('passwordModal').style.display = 'none';
                    document.getElementById('adminPassword').value = '';
                    document.getElementById('fileInput').click();
                } else {
                    alert('❌ Incorrect password.');
                    document.getElementById('adminPassword').focus();
                }
            });
            document.getElementById('fileInput').addEventListener('change', (e) => {
                if (e.target.files.length > 0) processFile(e.target.files[0]);
                e.target.value = null;
            });
            document.getElementById('searchBox').addEventListener('input', applyFilters);
            document.querySelectorAll('[data-filter]').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelector('[data-filter].active')?.classList.remove('active');
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    applyFilters();
                });
            });
            document.addEventListener('keydown', (e) => {
                const modal = document.getElementById('passwordModal');
                if (modal.style.display === 'flex') {
                    if (e.key === 'Enter') document.getElementById('accessBtn').click();
                    if (e.key === 'Escape') document.getElementById('cancelBtn').click();
                }
            });
        }
    </script>
</body>
</html>

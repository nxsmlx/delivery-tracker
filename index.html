<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qube-Inventory Delivery Aging Tracker</title>
    <link rel="icon" href="favicon.ico" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-light: #f8f9fa;
            --bg-dark: #f1f3f5;
            --surface: #ffffff;
            --border: #dee2e6;
            --shadow: rgba(0, 0, 0, 0.05) 0px 4px 6px -1px, rgba(0, 0, 0, 0.06) 0px 2px 4px -1px;
            --radius: 0.75rem;
            --text-primary: #212529;
            --text-secondary: #495057;
            --text-muted: #868e96;
            --accent-start: #4c6ef5;
            --accent-end: #748ffc;
            --accent-text: #ffffff;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --purple: #845ef7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-primary);
            padding: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 2rem;
            background: linear-gradient(135deg, var(--accent-start), var(--accent-end));
            color: var(--accent-text);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .header-content h1 {
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header-content p {
            font-size: 1rem;
            opacity: 0.9;
        }

        .header-info {
            text-align: right;
            font-size: 0.875rem;
        }
        
        #adminBtn {
            margin-bottom: 0.75rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background-color: var(--surface);
            padding: 1.5rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1.1;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.5rem;
        }

        .aging-0 { color: var(--info); }
        .aging-1 { color: var(--success); }
        .aging-2 { color: var(--warning); }
        .aging-3 { color: var(--danger); }
        .aging-4 { color: var(--purple); }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            align-items: flex-start;
        }

        .controls-and-reminders {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            position: sticky;
            top: 2rem;
        }
        
        .card {
             background-color: var(--surface);
             padding: 1.5rem;
             border-radius: var(--radius);
             border: 1px solid var(--border);
             box-shadow: var(--shadow);
        }

        .card-header {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }
        
        .controls .control-group {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .filter-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.5rem;
        }
        
        .search-box {
            width: 100%;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--accent-start);
            box-shadow: 0 0 0 3px rgba(76, 110, 245, 0.2);
        }
        
        .btn {
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            font-weight: 600;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .btn-primary {
            background-color: var(--accent-start);
            color: var(--accent-text);
        }
        .btn-primary:hover {
            background-color: #364fc7;
        }
        
        .btn-secondary {
            background-color: var(--bg-dark);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }
        .btn-secondary:hover {
            background-color: #e9ecef;
            border-color: #ced4da;
        }
        
        .btn-filter {
            background-color: var(--surface);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }
        .btn-filter:hover {
            background-color: var(--bg-light);
            border-color: #adb5bd;
        }
        .btn-filter.active {
            background: var(--accent-start);
            color: var(--accent-text);
            border-color: var(--accent-start);
        }
        .btn-filter.active.aging-0 { background: var(--info); border-color: var(--info); }
        .btn-filter.active.aging-1 { background: var(--success); border-color: var(--success); }
        .btn-filter.active.aging-2 { background: var(--warning); border-color: var(--warning); }
        .btn-filter.active.aging-3 { background: var(--danger); border-color: var(--danger); }
        .btn-filter.active.aging-4 { background: var(--purple); border-color: var(--purple); }
        .btn-filter.active.urgent { background: var(--danger); border-color: var(--danger); }

        #reminderContent .reminder-section {
            padding: 1rem;
            background-color: var(--bg-light);
            border-radius: var(--radius);
            margin-bottom: 1rem;
        }
        #reminderContent .reminder-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        #reminderContent .reminder-list {
            list-style: none;
        }
        #reminderContent .reminder-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            font-size: 0.875rem;
            border-bottom: 1px solid var(--border);
        }
        #reminderContent .reminder-item:last-child {
            border-bottom: none;
        }

        .table-wrapper {
            width: 100%;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            white-space: nowrap;
        }
        th, td {
            padding: 1rem;
            text-align: left;
            font-size: 0.875rem;
            border-bottom: 1px solid var(--border);
        }
        th {
            background-color: var(--bg-dark);
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        tbody tr:hover {
            background-color: var(--bg-light);
        }
        
        .badge {
            padding: 0.25rem 0.6rem;
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--accent-text);
        }
        .badge-aging-0 { background-color: var(--info); }
        .badge-aging-1 { background-color: var(--success); }
        .badge-aging-2 { background-color: var(--warning); }
        .badge-aging-3 { background-color: var(--danger); }
        .badge-aging-4 { background-color: var(--purple); }
        .badge-urgent { background-color: var(--danger); }
        .badge-priority-critical { background-color: var(--danger); }
        .badge-priority-high { background-color: var(--warning); }
        .badge-priority-medium { background-color: var(--accent-start); }
        .badge-priority-low { background-color: var(--success); }
        
        #statusMessage { margin: 0 0 1.5rem 0; }
        .status-message {
            padding: 1rem;
            border-radius: var(--radius);
            border: 1px solid;
        }
        .status-info { background-color: #e7f5ff; border-color: #a5d8ff; color: #1971c2; }
        .status-success { background-color: #d3f9d8; border-color: #96f2ab; color: #2f9e44; }
        .status-error { background-color: #ffe3e3; border-color: #ffc9c9; color: #c92a2a; }

        .modal {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000;
            align-items: center; justify-content: center;
        }
        .modal-content {
            background: var(--surface); border-radius: var(--radius); padding: 2rem;
            width: 400px; max-width: 90%; box-shadow: var(--shadow);
        }
        .modal h3 { margin-bottom: 1rem; color: var(--text-primary); }
        .modal p { margin-bottom: 1.5rem; color: var(--text-secondary); }
        .modal input {
            width: 100%; padding: 0.75rem; border: 1px solid var(--border);
            border-radius: var(--radius); margin-bottom: 1.5rem; font-size: 1rem;
        }
        .modal-buttons { display: flex; gap: 0.5rem; justify-content: flex-end; }
        
        @media (max-width: 1024px) {
            .main-content { grid-template-columns: 1fr; }
            .controls-and-reminders { position: static; }
        }
        @media (max-width: 768px) {
            body { padding: 1rem; }
            .header { flex-direction: column; gap: 1rem; text-align: center; }
            .header-info { text-align: center; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
            .filter-buttons { grid-template-columns: 1fr 1fr; }
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>Delivery Aging Tracker</h1>
                <p>Real-time dashboard for monitoring delivery performance.</p>
            </div>
            <div class="header-info">
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;">
                <button class="btn btn-primary" id="adminBtn">🔒 Admin Upload</button>
                 <div id="timezoneInfo" style="margin-top: 0.5rem;">
                    🕐 MYT: <span id="currentTime"></span>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card"><div class="stat-number aging-0" id="count-0">0</div><div class="stat-label">Same Day</div></div>
            <div class="stat-card"><div class="stat-number aging-1" id="count-1">0</div><div class="stat-label">1 Day</div></div>
            <div class="stat-card"><div class="stat-number aging-2" id="count-2">0</div><div class="stat-label">2 Days</div></div>
            <div class="stat-card"><div class="stat-number aging-3" id="count-3">0</div><div class="stat-label">3 Days</div></div>
            <div class="stat-card"><div class="stat-number aging-4" id="count-4">0</div><div class="stat-label">> 3 Days</div></div>
            <div class="stat-card"><div class="stat-number" style="color: var(--danger);" id="urgent-count">0</div><div class="stat-label">Urgent</div></div>
            <div class="stat-card"><div class="stat-number" id="total-count">0</div><div class="stat-label">Total</div></div>
        </div>

        <div id="statusMessage"></div>
        
        <div class="main-content">
            <div class="controls-and-reminders">
                <div class="card controls">
                    <div class="card-header">Filter & Search</div>
                    <div class="control-group">
                        <input type="text" class="search-box" id="searchBox" placeholder="Search by Ticket ID or Customer...">
                        <div class="filter-buttons">
                            <button class="btn btn-filter active" data-filter="all">All</button>
                            <button class="btn btn-filter aging-0" data-filter="0">Same Day</button>
                            <button class="btn btn-filter aging-1" data-filter="1">1 Day</button>
                            <button class="btn btn-filter aging-2" data-filter="2">2 Days</button>
                            <button class="btn btn-filter aging-3" data-filter="3">3 Days</button>
                            <button class="btn btn-filter aging-4" data-filter="4">> 3 Days</button>
                            <button class="btn btn-filter urgent" data-filter="urgent">Urgent</button>
                        </div>
                         <button class="btn btn-secondary" id="refreshBtn" style="width: 100%;">🔄 Refresh Data</button>
                    </div>
                </div>

                <div class="card reminders">
                    <div class="card-header">📋 Driver Action Items</div>
                    <div id="reminderContent"><div style="text-align: center; color: var(--text-muted); padding: 2rem;">Upload data to see action items.</div></div>
                </div>
            </div>

            <div class="card data-table">
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Ticket Info</th>
                                <th>Order Received</th>
                                <th>Urgent</th>
                                <th>Aging</th>
                                <th>Priority</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <h3>Admin Access Required</h3>
            <p>Enter the admin password to upload new delivery data.</p>
            <input type="password" id="adminPassword" placeholder="Enter password...">
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="cancelBtn">Cancel</button>
                <button class="btn btn-primary" id="accessBtn">Access</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', initialize);

        // ================================
        // CONFIGURATION - DO NOT CHANGE
        // ================================
        const CONFIG = {
            supabase: {
                url: 'https://iugwfmnfmulgxvaxjkwv.supabase.co',
                key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1Z3dmbW5mbXVsZ3h2YXhqa3d2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3MTU2MDIsImV4cCI6MjA2ODI5MTYwMn0.pUExanPG_BdTN11gtHg_cOubUkMOEv3n0a1mksLH_ZE',
                tableName: 'delivery_data'
            },
            adminPassword: 'qube2025',
            timezone: 'Asia/Kuala_Lumpur' // GMT+8
        };

        let deliveryData = [];
        let currentFilter = 'all';
        let supabase;

        // ================================
        // INITIALIZATION
        // ================================
        async function initialize() {
            initializeEventHandlers();
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000); // Update time every second

            try {
                initializeDatabase();
                const loadSuccess = await loadDataFromDatabase();
                if (!loadSuccess) {
                    renderSampleData();
                }
            } catch (error) {
                showMessage(`⚠️ Configuration Error: ${error.message}. Please check the script's CONFIG section.`, 'error');
                renderSampleData();
            }
            
            // Auto-refresh data every 30 seconds
            setInterval(loadDataFromDatabase, 30000);
        }

        // ================================
        // TIME & DATE UTILITIES
        // ================================
        function updateCurrentTime() {
            const currentTimeElement = document.getElementById('currentTime');
            if (currentTimeElement) {
                currentTimeElement.textContent = new Date().toLocaleTimeString('en-MY', {
                    timeZone: CONFIG.timezone,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }
        }

        function calculateAging(orderReceivedDateStr) {
            if (!orderReceivedDateStr || typeof orderReceivedDateStr !== 'string') {
                return NaN;
            }

            let orderDate;
            const parts = orderReceivedDateStr.split(/[/.-]/);

            if (parts.length === 3) {
                // Assuming DD/MM/YYYY format, common in Malaysia.
                // It can also handle MM/DD/YYYY if the year is clearly specified.
                const day = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10);
                const year = parseInt(parts[2], 10);

                if (year > 1900) { // DD/MM/YYYY
                    orderDate = new Date(year, month - 1, day);
                } else { // MM/DD/YY
                    orderDate = new Date(2000 + year, day - 1, month);
                }
            } else {
                // Fallback for other formats like YYYY-MM-DD
                orderDate = new Date(orderReceivedDateStr);
            }

            // Check for invalid date
            if (isNaN(orderDate.getTime())) {
                return NaN;
            }

            const today = new Date();
            const todayInTimezone = new Date(today.toLocaleString('en-US', { timeZone: CONFIG.timezone }));

            // Set both dates to midnight for accurate day difference
            orderDate.setHours(0, 0, 0, 0);
            todayInTimezone.setHours(0, 0, 0, 0);

            const diffTime = todayInTimezone.getTime() - orderDate.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            return Math.max(0, diffDays);
        }
        
        // ================================
        // SUPABASE CLIENT
        // ================================
        class SupabaseClient {
            constructor(url, key) {
                this.url = url;
                this.headers = {
                    'apikey': key,
                    'Authorization': `Bearer ${key}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                };
            }

            async query(method, endpoint, data = null) {
                const url = `${this.url}/rest/v1/${endpoint}`;
                const response = await fetch(url, {
                    method,
                    headers: this.headers,
                    body: data ? JSON.stringify(data) : null
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(`Database error: ${response.status} - ${error}`);
                }
                // DELETE might not return a body, handle it gracefully
                return response.status === 204 ? [] : response.json();
            }

            getDeliveryData() {
                return this.query('GET', `${CONFIG.supabase.tableName}?select=*&order=created_at.desc`);
            }

            async saveDeliveryData(data) {
                await this.query('DELETE', `${CONFIG.supabase.tableName}?id=gte.1`);
                if (!data || data.length === 0) return;
                
                const records = data.map(item => ({
                    ticket_id: item.ticketId,
                    order_received: item.orderReceived,
                    type: item.type || '',
                    urgent: item.urgent || 'No',
                    customer: item.customer || '',
                    aging: item.aging,
                }));
                
                await this.query('POST', CONFIG.supabase.tableName, records);
            }
        }
        
        function initializeDatabase() {
            if (!CONFIG.supabase.url || !CONFIG.supabase.key) {
                throw new Error('Supabase URL or API key is not configured.');
            }
            supabase = new SupabaseClient(CONFIG.supabase.url, CONFIG.supabase.key);
        }
        
        // ================================
        // DATA HANDLING
        // ================================
        async function loadDataFromDatabase() {
            try {
                showMessage('🔄 Loading latest data from the cloud...', 'info');
                const data = await supabase.getDeliveryData();
                
                // Process and clean data
                deliveryData = (data || []).map(item => ({
                    ticketId: item.ticket_id,
                    orderReceived: item.order_received,
                    type: item.type,
                    urgent: item.urgent,
                    customer: item.customer,
                    aging: calculateAging(item.order_received)
                })).filter(item => !isNaN(item.aging)); // Filter out items with invalid aging
                
                updateAllUI();
                showMessage(`✅ Data loaded successfully. Displaying ${deliveryData.length} pending items.`, 'success');
                return true;
            } catch (error) {
                showMessage(`❌ Could not load data from database: ${error.message}`, 'error');
                return false;
            }
        }

        async function saveDataToDatabase(data) {
            try {
                showMessage('📤 Uploading and saving new data to the cloud...', 'info');
                await supabase.saveDeliveryData(data);
                showMessage('✅ Data saved successfully! Refreshing view.', 'success');
                // Immediately reload to show the new data
                setTimeout(loadDataFromDatabase, 1000);
            } catch (error) {
                showMessage(`❌ Failed to save data: ${error.message}`, 'error');
            }
        }

        function renderSampleData() {
             deliveryData = [
                { ticketId: '60210', orderReceived: '11/7/2025', type: 'Delivery', urgent: 'Yes', customer: 'Segi University' },
                { ticketId: '60521', orderReceived: '14/7/2025', type: 'Delivery', urgent: 'No', customer: 'Ingram' },
                { ticketId: '60570', orderReceived: '15/7/2025', type: 'Delivery', urgent: 'No', customer: 'Imazium' },
             ].map(item => ({...item, aging: calculateAging(item.orderReceived) }))
              .filter(item => !isNaN(item.aging));
             
             updateAllUI();
        }

        // ================================
        // UI UPDATES & RENDERING
        // ================================
        function updateAllUI() {
            updateStats();
            applyFilters(); // This will call renderTable and updateReminders
        }

        function showMessage(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
            setTimeout(() => {
                if (statusDiv.innerHTML.includes(message)) {
                    statusDiv.innerHTML = '';
                }
            }, 5000);
        }

        function updateStats() {
            const stats = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0 };
            let urgentCount = 0;
            
            deliveryData.forEach(item => {
                const aging = item.aging;
                if (aging <= 3) stats[aging]++;
                else stats[4]++;
                if (item.urgent && item.urgent.toLowerCase() === 'yes') urgentCount++;
            });

            for (let i = 0; i <= 4; i++) {
                document.getElementById(`count-${i}`).textContent = stats[i];
            }
            document.getElementById('urgent-count').textContent = urgentCount;
            document.getElementById('total-count').textContent = deliveryData.length;
        }
        
        function applyFilters() {
            let filtered = [...deliveryData];

            if (currentFilter === 'urgent') {
                filtered = filtered.filter(item => item.urgent && item.urgent.toLowerCase() === 'yes');
            } else if (currentFilter !== 'all') {
                const targetAging = parseInt(currentFilter, 10);
                if (targetAging === 4) {
                    filtered = filtered.filter(item => item.aging > 3);
                } else {
                    filtered = filtered.filter(item => item.aging === targetAging);
                }
            }

            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(item => 
                    item.ticketId.toLowerCase().includes(searchTerm) || 
                    item.customer.toLowerCase().includes(searchTerm)
                );
            }
            
            renderTable(filtered);
            updateReminders(filtered);
        }
        
        function getPriority(item) {
            if (item.urgent === 'Yes' || item.aging > 3) return { class: 'critical', text: 'Critical' };
            if (item.aging === 3) return { class: 'high', text: 'High' };
            if (item.aging === 2) return { class: 'medium', text: 'Medium' };
            return { class: 'low', text: 'Low' };
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 2rem;">No items match your current filter.</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(item => {
                const priority = getPriority(item);
                return `
                    <tr>
                        <td>
                            <div><strong>${item.ticketId}</strong></div>
                            <small style="color:var(--text-muted);">${item.customer || 'N/A'}</small>
                        </td>
                        <td>${item.orderReceived}</td>
                        <td>${item.urgent === 'Yes' ? '<span class="badge badge-urgent">URGENT</span>' : 'No'}</td>
                        <td><span class="badge badge-aging-${item.aging <= 3 ? item.aging : 4}">${item.aging} Day${item.aging !== 1 ? 's' : ''}</span></td>
                        <td><span class="badge badge-priority-${priority.class}">${priority.text}</span></td>
                    </tr>
                `;
            }).join('');
        }
        
        function updateReminders(data = deliveryData) {
            const reminderContent = document.getElementById('reminderContent');
            const overdue = data.filter(item => item.aging > 3);
            const today = data.filter(item => item.aging === 3);
            const tomorrow = data.filter(item => item.aging === 2);
            
            let html = '';
            
            if (overdue.length > 0) html += createReminderSection('🚨 Overdue - Urgent Action!', overdue);
            if (today.length > 0) html += createReminderSection('📅 Due Today (Last Day)', today);
            if (tomorrow.length > 0) html += createReminderSection('📋 Plan for Tomorrow', tomorrow);
            
            if (html === '') {
                 html = `<div style="text-align: center; color: var(--success); padding: 2rem;">✅ Great job! No immediate actions required.</div>`;
            }

            reminderContent.innerHTML = html;
        }
        
        function createReminderSection(title, items) {
             return `
                <div class="reminder-section">
                    <div class="reminder-title">${title}</div>
                    <ul class="reminder-list">
                        ${items.map(item => `
                            <li class="reminder-item">
                                <div><strong>${item.ticketId}</strong> - ${item.customer}</div>
                                <span class="badge badge-aging-${item.aging <=3 ? item.aging : 4}">${item.aging} Days</span>
                            </li>
                        `).join('')}
                    </ul>
                </div>`;
        }

        // ================================
        // FILE PROCESSING
        // ================================
        function convertExcelDate(serial) {
            if (!serial || isNaN(serial)) return serial; // Return original if not a number
            const excelEpoch = new Date(1899, 11, 30);
            const date = new Date(excelEpoch.getTime() + parseInt(serial, 10) * 86400000);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        function processFile(file) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    let data;
                    const fileName = file.name.toLowerCase();
                    const arrayBuffer = e.target.result;
                    
                    if (fileName.endsWith('.csv')) {
                        const text = new TextDecoder("utf-8").decode(arrayBuffer);
                        data = parseDelimitedText(text);
                    } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                        data = parseExcel(arrayBuffer);
                    } else {
                        throw new Error('Unsupported file. Please use .xlsx, .xls, or .csv.');
                    }
                    
                    if (data.length === 0) {
                        throw new Error('No valid data found in the file.');
                    }
                    
                    await saveDataToDatabase(data);
                } catch (error) {
                    showMessage(`❌ Error processing file: ${error.message}`, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function parseData(jsonData) {
             const headers = jsonData[0].map(h => h.toString().toLowerCase().trim());
             const rows = jsonData.slice(1);
             
             const findIndex = (names) => {
                 for (const name of names) {
                     const index = headers.indexOf(name);
                     if (index !== -1) return index;
                 }
                 return -1;
             };
             
             const cols = {
                ticketId: findIndex(['ticket id', 'ticketid', 'ticket']),
                orderReceived: findIndex(['order received', 'orderreceived', 'date']),
                type: findIndex(['type', 'service type']),
                urgent: findIndex(['urgent', 'urgent?']),
                customer: findIndex(['customer', 'client']),
             };

            if (cols.ticketId === -1 || cols.orderReceived === -1) {
                throw new Error("File must contain 'Ticket ID' and 'Order Received' columns.");
            }

            return rows.map(row => {
                const rawDate = row[cols.orderReceived];
                const convertedDate = (typeof rawDate === 'number') ? convertExcelDate(rawDate) : rawDate;
                const aging = calculateAging(convertedDate);

                // Skip rows with invalid aging
                if (isNaN(aging)) return null;

                return {
                    ticketId: row[cols.ticketId].toString(),
                    orderReceived: convertedDate,
                    type: row[cols.type] || 'N/A',
                    urgent: row[cols.urgent] || 'No',
                    customer: row[cols.customer] || 'N/A',
                    aging: aging,
                };
            }).filter(Boolean); // Filter out null items
        }

        function parseExcel(arrayBuffer) {
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: true, defval: '' });
            return parseData(jsonData);
        }

        function parseDelimitedText(text) {
            const jsonData = text.split('\n').map(line => line.split(',').map(cell => cell.trim()));
            return parseData(jsonData);
        }
        
        // ================================
        // EVENT HANDLERS
        // ================================
        function initializeEventHandlers() {
            document.getElementById('adminBtn').addEventListener('click', () => {
                document.getElementById('passwordModal').style.display = 'flex';
                document.getElementById('adminPassword').focus();
            });
            
            document.getElementById('refreshBtn').addEventListener('click', loadDataFromDatabase);

            document.getElementById('cancelBtn').addEventListener('click', () => {
                document.getElementById('passwordModal').style.display = 'none';
                document.getElementById('adminPassword').value = '';
            });

            document.getElementById('accessBtn').addEventListener('click', () => {
                if (document.getElementById('adminPassword').value === CONFIG.adminPassword) {
                    document.getElementById('passwordModal').style.display = 'none';
                    document.getElementById('adminPassword').value = '';
                    document.getElementById('fileInput').click();
                } else {
                    alert('❌ Incorrect password.');
                    document.getElementById('adminPassword').focus();
                }
            });

            document.getElementById('fileInput').addEventListener('change', (e) => {
                if (e.target.files.length > 0) processFile(e.target.files[0]);
                e.target.value = null; // Reset input
            });
            
            document.getElementById('searchBox').addEventListener('input', applyFilters);

            document.querySelectorAll('[data-filter]').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('[data-filter]').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    applyFilters();
                });
            });

            document.addEventListener('keydown', (e) => {
                const modal = document.getElementById('passwordModal');
                if (modal.style.display === 'flex') {
                    if (e.key === 'Enter') document.getElementById('accessBtn').click();
                    if (e.key === 'Escape') document.getElementById('cancelBtn').click();
                }
            });
        }
    </script>
</body>
</html>

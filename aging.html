<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Aging Tracker</title>
    <link rel="icon" href="favicon.ico" type="image/png">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js for the new chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        :root{
            --bg-gradient: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            --surface: #ffffff;
            --surface-hover: #f8fafc;
            --surface-2: #f1f5f9;
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --primary-light: #e0e7ff;
            --secondary: #14b8a6;
            --secondary-light: #ccfbf1;
            --accent: #f59e0b;
            --accent-light: #fef3c7;
            --success: #10b981;
            --success-light: #d1fae5;
            --error: #ef4444;
            --error-light: #fee2e2;
            --same-day: #3b82f6;
            --same-day-light: #dbeafe;
            --text: #0f172a;
            --text-muted: #64748b;
            --text-light: #94a3b8;
            --border: #e2e8f0;
            --border-light: #f1f5f9;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --radius: 16px;
            --radius-sm: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-gradient);
            color: var(--text);
            line-height: 1.6;
            font-weight: 400;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header Styles */
        .header {
            text-align: center;
            margin-bottom: 3rem;
            background: var(--surface);
            padding: 3rem 2rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.5rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }
        
        .header h1 .title-text {
             background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header h1 svg {
            width: 2.5rem;
            height: 2.5rem;
            color: var(--primary);
        }

        .header p {
            color: var(--text-muted);
            font-size: 1.125rem;
            margin-bottom: 1.5rem;
            font-weight: 400;
        }

        .target-notice {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary-light), var(--secondary-light));
            padding: 1.5rem 2rem;
            border-radius: var(--radius-sm);
            border: 1px solid var(--primary);
            font-size: 0.875rem;
            color: var(--text);
            box-shadow: var(--shadow);
        }

        .target-notice strong {
            color: var(--primary);
            font-weight: 600;
        }

        .target-notice em {
            display: block;
            margin-top: 0.5rem;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .target-notice a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }

        .target-notice a:hover {
            text-decoration: underline;
        }

        /* Action Bar */
        .page-actions-container {
            background: var(--surface);
            padding: 1.5rem 2rem;
            border-radius: var(--radius);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            border: none;
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            border-radius: var(--radius-sm);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            box-shadow: var(--shadow);
        }
        
        .btn svg {
            width: 1rem;
            height: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-hover));
            color: white;
            border: 1px solid var(--primary);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
            background: linear-gradient(135deg, var(--primary-hover), var(--primary));
        }

        .btn-secondary {
            background: var(--surface);
            color: var(--text);
            border: 2px solid var(--border);
            transition: all 0.2s ease;
        }

        .btn-secondary:hover,
        .btn-secondary.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary.aging-0.active { background: var(--same-day); border-color: var(--same-day); }
        .btn-secondary.aging-1.active { background: var(--success); border-color: var(--success); }
        .btn-secondary.aging-2.active { background: var(--accent); border-color: var(--accent); }
        .btn-secondary.aging-3.active { background: var(--error); border-color: var(--error); }
        .btn-secondary.aging-4.active { background: #8b5cf6; border-color: #8b5cf6; }
        .btn-secondary.urgent.active { background: var(--accent); border-color: var(--accent); }

        .btn-icon {
            background: var(--surface);
            border: 2px solid var(--border);
            color: var(--text-muted);
            padding: 0.75rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .btn-icon:hover {
            background: var(--primary-light);
            color: var(--primary);
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Stats Grid */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            padding: 2rem 1.5rem;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            background: var(--surface-hover);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            line-height: 1.2;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 600;
        }

        .aging-0 { color: var(--same-day); }
        .aging-1 { color: var(--success); }
        .aging-2 { color: var(--accent); }
        .aging-3 { color: var(--error); }
        .aging-4 { color: #8b5cf6; }

        /* Controls */
        .controls {
            background: var(--surface);
            padding: 2rem;
            border-radius: var(--radius);
            margin-bottom: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .control-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }

        .search-box {
            flex: 1 1 300px;
            padding: 1rem 1.25rem;
            background: var(--surface-2);
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            outline: none;
            transition: all 0.2s ease;
            font-family: inherit;
            font-size: 0.875rem;
        }

        .search-box:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
            background: var(--surface);
        }

        .search-box::placeholder {
            color: var(--text-light);
        }

        /* Status Messages */
        .status-message {
            margin: 0 0 2rem 0;
            padding: 1rem 1.5rem;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            border: 1px solid transparent;
            transition: opacity 0.5s ease-out;
            font-weight: 500;
        }

        .status-info {
            background: var(--primary-light);
            border-color: var(--primary);
            color: var(--primary-hover);
        }

        .status-success {
            background: var(--success-light);
            border-color: var(--success);
            color: var(--success);
        }

        .status-error {
            background: var(--error-light);
            border-color: var(--error);
            color: var(--error);
        }

        /* Dashboard Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            align-items: flex-start;
        }
        
        /* Reminders & Location Summary Section */
        .reminders, .summary-card {
            background: var(--surface);
            padding: 2rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }
        
        .summary-card {
            margin-top: 2rem;
        }
        
        .reminders h3, .summary-card h3 {
            color: var(--text);
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .reminders h3 svg, .summary-card h3 svg {
            width: 1.25rem;
            height: 1.25rem;
            color: var(--primary);
        }

        .reminder-section {
            background: var(--surface-2);
            border-radius: var(--radius-sm);
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border-light);
        }

        .reminder-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
        }
        
        .reminder-title svg {
            width: 1rem;
            height: 1rem;
        }

        .reminder-remark {
            font-size: 0.8em;
            font-style: italic;
            color: var(--text-muted);
            font-weight: 400;
            margin-bottom: 1rem;
        }

        .reminder-list {
            list-style: none;
        }

        .reminder-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-light);
        }

        .reminder-item:last-child {
            border-bottom: none;
        }

        /* Location Summary Table */
        .location-summary table {
            width: 100%;
            border-collapse: collapse;
        }
        .location-summary th, .location-summary td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-light);
        }
        .location-summary th {
            text-align: left;
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
        }
        .location-summary td:last-child {
            text-align: right;
            font-weight: 700;
            color: var(--primary);
        }

        /* Data Table */
        .data-table {
            background: var(--surface);
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-top: 2rem;
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 1.25rem 1rem;
            text-align: left;
            font-size: 0.875rem;
            vertical-align: middle;
            border-bottom: 1px solid var(--border-light);
        }

        th {
            background: var(--surface-2);
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.1em;
        }

        tbody tr:hover {
            background: var(--surface-hover);
        }

        .location-group-header td {
            background-color: var(--primary-light);
            font-weight: 700;
            font-size: 1rem;
            padding: 1rem 1.25rem;
            color: var(--primary-hover);
            border-top: 2px solid var(--primary);
            border-bottom: 1px solid var(--primary);
        }

        /* Badges */
        .badge {
            padding: 0.5rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            color: white;
            display: inline-block;
            box-shadow: var(--shadow);
        }

        .badge-aging-0 { background: var(--same-day); }
        .badge-aging-1 { background: var(--success); }
        .badge-aging-2 { background: var(--accent); color: var(--text); }
        .badge-aging-3 { background: var(--error); }
        .badge-aging-4 { background: #8b5cf6; }
        .badge-urgent { background: var(--error); }

        .action-btn {
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            border: none;
            cursor: default;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .action-btn.urgent { background: var(--error); }
        .action-btn.overdue { background: #d946ef; }
        .action-btn.today { background: var(--accent); color: var(--text); }
        .action-btn.tomorrow { background: var(--same-day); }
        .action-btn.scheduled { background: var(--success); }

        /* Ticket Info */
        .ticket-info .ticket-main-line {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .ticket-info .ticket-id {
            font-weight: 700;
            color: var(--primary);
        }

        .ticket-info .ticket-customer {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
            font-weight: 400;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 2rem;
            width: 400px;
            max-width: 90%;
            color: var(--text);
            box-shadow: var(--shadow-xl);
        }

        .modal h3 {
            margin-bottom: 1rem;
            color: var(--primary);
            font-weight: 600;
        }

        .modal p {
            margin-bottom: 1.25rem;
            color: var(--text-muted);
        }

        .modal input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--surface-2);
            color: var(--text);
            margin-bottom: 1.25rem;
            font-family: inherit;
            transition: border-color 0.2s ease;
        }

        .modal input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .modal-buttons {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        .no-data {
            padding: 3rem;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        /* Responsive Design */
        @media (max-width: 992px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .header { padding: 2rem 1rem; }
            .header h1 { font-size: 2rem; }
            .page-actions-container { flex-direction: column; align-items: stretch; }
            .stats { grid-template-columns: repeat(2, 1fr); }
            .control-group { flex-direction: column; align-items: stretch; }
            .search-box { flex: 1; }
        }

        @media (max-width: 480px) {
            .stats { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17.2119 14.3662L15.8166 7.11618C15.6942 6.49343 15.1216 6 14.4764 6H9.52358C8.87841 6 8.30578 6.49343 8.1834 7.11618L6.78809 14.3662C5.06284 14.8343 4 16.2998 4 18C4 19.6569 5.34315 21 7 21C8.65685 21 10 19.6569 10 18C10 16.3533 8.7234 14.915 7.0401 14.4182L8.43541 7.16819C8.48347 6.92004 8.69176 6.75 8.94436 6.75H15.0556C15.3082 6.75 15.5165 6.92004 15.5646 7.16819L16.9599 14.4182C15.2766 14.915 14 16.3533 14 18C14 19.6569 15.3431 21 17 21C18.6569 21 20 19.6569 20 18C20 16.2998 18.9372 14.8343 17.2119 14.3662ZM7 20C5.89543 20 5 19.1046 5 18C5 16.8954 5.89543 16 7 16C8.10457 16 9 16.8954 9 18C9 19.1046 8.10457 20 7 20ZM17 20C15.8954 20 15 19.1046 15 18C15 16.8954 15.8954 16 17 16C18.1046 16 19 16.8954 19 18C19 19.1046 18.1046 20 17 20Z"></path><path d="M20 11H4V13H20V11Z"></path></svg>
                <span class="title-text">Delivery Aging Tracker</span>
            </h1>
            <p>Monitor delivery performance and aging statistics with real-time insights</p>
            <div class="target-notice">
                <strong>🎯 Target:</strong> All deliveries to be completed within 3 days
                <em>*Same Day tickets include newly created orders and rescheduled deliveries</em>
                <em>📊 Showing pending deliveries only (aging ≥ 1 day) • <a href="/">View complete analytics</a></em>
            </div>
        </header>

        <div class="page-actions-container">
            <button class="btn btn-secondary" id="refreshBtn">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22ZM12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20ZM12 16C9.79086 16 8 14.2091 8 12H6C6 15.3137 8.68629 18 12 18V16ZM16 12C16 9.79086 14.2091 8 12 8V6C15.3137 6 18 8.68629 18 12H16Z"></path></svg>
                Refresh Data
            </button>
            <a href="/" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 12H5V21H3V12ZM7 6H9V21H7V6ZM11 16H13V21H11V16ZM15 10H17V21H15V10ZM19 3H21V21H19V3Z"></path></svg>
                Analytics Dashboard
            </a>
            <button class="btn-icon" id="adminBtn" title="Admin Panel">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            </button>
        </div>

        <div id="statusMessage"></div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number aging-0" id="count-0">0</div>
                <div class="stat-label">Same Day</div>
            </div>
            <div class="stat-card">
                <div class="stat-number aging-1" id="count-1">0</div>
                <div class="stat-label">1 Day Aging</div>
            </div>
            <div class="stat-card">
                <div class="stat-number aging-2" id="count-2">0</div>
                <div class="stat-label">2 Days Aging</div>
            </div>
            <div class="stat-card">
                <div class="stat-number aging-3" id="count-3">0</div>
                <div class="stat-label">3 Days Aging</div>
            </div>
            <div class="stat-card">
                <div class="stat-number aging-4" id="count-4">0</div>
                <div class="stat-label">> 3 Days Aging</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" style="color: var(--accent);" id="urgent-count">0</div>
                <div class="stat-label">Urgent Tickets</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-count">0</div>
                <div class="stat-label">Total Pending</div>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;">
            </div>
            <div class="control-group">
                <input type="text" class="search-box" id="searchBox" placeholder="🔍 Search by Ticket ID or Customer...">
                <button class="btn btn-secondary active" data-filter="all">All</button>
                <button class="btn btn-secondary aging-0" data-filter="0">Same Day</button>
                <button class="btn btn-secondary aging-1" data-filter="1">1 Day</button>
                <button class="btn btn-secondary aging-2" data-filter="2">2 Days</button>
                <button class="btn btn-secondary aging-3" data-filter="3">3 Days</button>
                <button class="btn btn-secondary aging-4" data-filter="4">> 3 Days</button>
                <button class="btn btn-secondary urgent" data-filter="urgent">Urgent</button>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="reminders">
                <h3>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 2H8C4.68629 2 2 4.68629 2 8V16C2 19.3137 4.68629 22 8 22H16C19.3137 22 22 19.3137 22 16V8C22 4.68629 19.3137 2 16 2ZM20 16C20 18.2091 18.2091 20 16 20H8C5.79086 20 4 18.2091 4 16V8C4 5.79086 5.79086 4 8 4H16C18.2091 4 20 5.79086 20 8V16ZM15 8H9V10H15V8ZM15 11H9V13H15V11ZM11 14H9V16H11V14Z"></path></svg>
                    Driver Action Items
                </h3>
                <div id="reminderContent">
                    <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                        📤 Upload your delivery data to see prioritized action items
                    </div>
                </div>
            </div>
            <div class="right-column">
                <div class="summary-card location-summary">
                     <h3>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 20.8995L18.364 14.5355L16.9497 13.1213L12 18.0711L7.05025 13.1213L5.63604 14.5355L12 20.8995ZM12 3.10051L18.364 9.46447L16.9497 10.8787L12 5.92893L7.05025 10.8787L5.63604 9.46447L12 3.10051Z"></path></svg>
                        Pending by Location
                    </h3>
                    <div id="locationSummaryContent">
                         <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                            No data to summarize.
                        </div>
                    </div>
                </div>
                <div class="summary-card">
                    <h3>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C17.52 2 22 6.48 22 12C22 17.52 17.52 22 12 22C6.48 22 2 17.52 2 12C2 6.48 6.48 2 12 2ZM11 15H13V17H11V15ZM13 6H11V13H13V6Z"></path></svg>
                        Pending by Aging
                    </h3>
                    <canvas id="agingChart"></canvas>
                </div>
            </div>
        </div>

        <div class="data-table">
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Ticket Details</th>
                            <th>Order Received</th>
                            <th>Urgent?</th>
                            <th>Aging</th>
                            <th>Action Required</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="5" class="no-data">
                                📋 No pending tickets found. Upload data to get started.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <h3>🔐 Admin Access Required</h3>
            <p>Enter admin password to upload delivery data:</p>
            <input type="password" id="adminPassword" placeholder="Enter password...">
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="cancelBtn">Cancel</button>
                <button class="btn btn-primary" id="accessBtn">Access</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // ================================
        // CONFIGURATION - DUAL DATABASE SUPPORT
        // ================================
        const CONFIG = {
            supabase: {
                url: 'https://iugwfmnfmulgxvaxjkwv.supabase.co',
                key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1Z3dmbW5mbXVsZ3h2YXhqa3d2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3MTU2MDIsImV4cCI6MjA2ODI5MTYwMn0.pUExanPG_BdTN11gtHg_cOubUkMOEv3n0a1mksLH_ZE',
                tableName: 'delivery_data',        // Aging tracker table (filtered data)
                analyticsTable: 'delivery_analytics' // Statistics table (complete data)
            },
            adminPassword: 'qube2025'
        };

        // Data will be loaded from the database
        let deliveryData = [];
        let currentFilter = 'all';
        let filteredData = [];
        let agingChartInstance = null; // To hold the chart instance

        // ================================
        // SUPABASE CLIENT - UPDATED WITH DUAL DATABASE SUPPORT
        // ================================
        class SupabaseClient {
            constructor(url, key) {
                this.url = url;
                this.key = key;
                this.headers = {
                    'apikey': key,
                    'Authorization': `Bearer ${key}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                };
            }

            async query(method, endpoint, data = null) {
                const url = `${this.url}/rest/v1/${endpoint}`;
                const response = await fetch(url, {
                    method,
                    headers: this.headers,
                    body: data ? JSON.stringify(data) : null
                });

                if (!response.ok) {
                    const error = await response.text();
                    console.error('Supabase error:', error);
                    throw new Error(`Database error: ${response.status} - ${error}`);
                }
                
                if (response.status === 204) return null; // No content for DELETE
                
                return await response.json();
            }

            async getDeliveryData() {
                try {
                    const data = await this.query('GET', `${CONFIG.supabase.tableName}?select=*&order=created_at.desc`);
                    return data || [];
                } catch (error) {
                    console.error('Error getting delivery data:', error);
                    return [];
                }
            }

            async clearDeliveryData() {
                try {
                    await this.query('DELETE', `${CONFIG.supabase.tableName}?id=gte.1`);
                    return true;
                } catch (error) {
                    console.error('Error clearing data:', error);
                    return false;
                }
            }

            // Save filtered data to aging tracker table (aging >= 1 only)
            async saveDeliveryData(data) {
                try {
                    await this.clearDeliveryData();
                    
                    if (!data || data.length === 0) {
                        await this.updateMetadata(0, 0);
                        return true;
                    }

                    // Filter only pending deliveries (aging >= 1)
                    const filteredRecords = data
                        .filter(item => item.aging >= 1)
                        .map((item) => ({
                            ticket_id: item.ticketId,
                            order_received: item.orderReceived,
                            type: item.type || '',
                            urgent: item.urgent || 'No',
                            customer: item.customer || '',
                            aging: parseInt(item.aging) || 0,
                            loc: item.loc || 'N/A', // Modified: Added location
                            updated_by: 'Admin'
                        }));

                    if (filteredRecords.length > 0) {
                        await this.query('POST', CONFIG.supabase.tableName, filteredRecords);
                    }
                    
                    console.log(`✅ Saved ${filteredRecords.length} pending records to aging tracker`);
                    return true;
                } catch (error) {
                    console.error('Error saving delivery data:', error);
                    throw error;
                }
            }

            // Save complete data to analytics table (ALL records)
            async saveCompleteAnalyticsData(data) {
                try {
                    // Clear existing analytics data
                    await this.query('DELETE', `${CONFIG.supabase.analyticsTable}?id=gte.1`);
                    
                    if (!data || data.length === 0) {
                        return true;
                    }

                    // Save ALL records to analytics table (including completed deliveries)
                    const records = data.map((item) => ({
                        ticket_id: item.ticketId,
                        order_received: item.orderReceived,
                        type: item.type || '',
                        urgent: item.urgent || 'No',
                        customer: item.customer || '',
                        aging: parseInt(item.aging) || 0,
                        loc: item.loc || 'N/A', // Modified: Added location
                        status: parseInt(item.aging) >= 1 ? 'Pending' : 'Completed',
                        updated_by: 'Admin'
                    }));

                    await this.query('POST', CONFIG.supabase.analyticsTable, records);
                    console.log(`✅ Saved ${records.length} records to analytics database`);
                    return true;
                } catch (error) {
                    console.error('Error saving analytics data:', error);
                    throw error;
                }
            }

            async getMetadata() {
                try {
                    const result = await this.query('GET', 'delivery_metadata?select=*&order=id.desc&limit=1');
                    return (result && result.length > 0) ? result[0] : { last_update: 'Never', total_records: 0 };
                } catch (error) {
                    console.error('Error getting metadata:', error);
                    return { last_update: 'Never', total_records: 0 };
                }
            }

            // Include analytics record count
            async updateMetadata(recordCount = 0, analyticsCount = 0) {
                try {
                    const metadata = {
                        last_update: new Date().toLocaleString('en-MY', {
                            timeZone: 'Asia/Kuala_Lumpur',
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            hour12: true
                        }),
                        updated_by: 'Admin',
                        total_records: recordCount,
                        analytics_records: analyticsCount,
                        updated_at: new Date().toISOString()
                    };

                    const updateResult = await this.query('PATCH', 'delivery_metadata?id=eq.1', metadata);
                    if (!updateResult || updateResult.length === 0) {
                        await this.query('POST', 'delivery_metadata', [{ id: 1, ...metadata }]);
                    }
                    return true;
                } catch (error) {
                    console.error('Error updating metadata:', error);
                    return false;
                }
            }
        }

        let supabase;

        function initializeDatabase() {
            if (!supabase) {
                 if (!CONFIG.supabase.url || CONFIG.supabase.url === 'YOUR_SUPABASE_URL') {
                    throw new Error('Supabase URL not configured');
                }
                if (!CONFIG.supabase.key || CONFIG.supabase.key === 'YOUR_SUPABASE_ANON_KEY') {
                    throw new Error('Supabase API key not configured');
                }
                supabase = new SupabaseClient(CONFIG.supabase.url, CONFIG.supabase.key);
            }
        }

        // ================================
        // UTILITY FUNCTIONS
        // ================================
        function showMessage(message, type = 'info', duration = 5000) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, duration);
            }
        }

        function toProperCase(str) {
            if (!str) return '';
            return String(str).toUpperCase();
        }

        function updateStats() {
            const stats = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0 };
            let totalPending = 0;
            let urgentCount = 0;
            
            deliveryData.forEach(item => {
                if (item.aging !== undefined && item.aging >= 0) {
                    const displayAging = Math.max(0, item.aging - 1);
                    
                    if (displayAging <= 3) {
                        stats[displayAging]++;
                    } else {
                        stats[4]++;
                    }
                    totalPending++;
                }
                if (item.urgent && item.urgent.toLowerCase() === 'yes') {
                    urgentCount++;
                }
            });

            document.getElementById('count-0').textContent = stats[0];
            document.getElementById('count-1').textContent = stats[1];
            document.getElementById('count-2').textContent = stats[2];
            document.getElementById('count-3').textContent = stats[3];
            document.getElementById('count-4').textContent = stats[4];
            document.getElementById('urgent-count').textContent = urgentCount;
            document.getElementById('total-count').textContent = totalPending;
        }

        // ================================
        // DATA RENDERING
        // ================================
        function getAgingBadge(aging) {
            const displayAging = Math.max(0, aging - 1);
            if (displayAging === 0) return `<span class="badge badge-aging-0">Same Day</span>`;
            if (displayAging <= 3) return `<span class="badge badge-aging-${displayAging}">${displayAging} Day${displayAging > 1 ? 's' : ''}</span>`;
            return `<span class="badge badge-aging-4">${displayAging} Days</span>`;
        }

        function getActionRequired(item) {
            const displayAging = Math.max(0, item.aging - 1);
            if (item.urgent === 'Yes') return { class: 'urgent', text: 'Urgent' };
            if (displayAging > 3) return { class: 'overdue', text: 'Overdue' };
            if (displayAging === 3) return { class: 'today', text: 'Today' };
            if (displayAging === 2) return { class: 'tomorrow', text: 'Tomorrow' };
            if (displayAging === 1) return { class: 'scheduled', text: 'Plan Ahead' };
            return { class: 'scheduled', text: 'Same Day' };
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="no-data">📋 No pending tickets found</td></tr>';
                return;
            }

            const groupBy = (arr, key) => arr.reduce((acc, item) => {
                const groupKey = item[key] || 'Unassigned';
                (acc[groupKey] = acc[groupKey] || []).push(item);
                return acc;
            }, {});

            const groupedData = groupBy(data, 'loc');
            const sortedLocations = Object.keys(groupedData).sort();

            let html = '';
            for (const location of sortedLocations) {
                const items = groupedData[location];
                html += `
                    <tr class="location-group-header">
                        <td colspan="5">${location} (${items.length} pending)</td>
                    </tr>
                `;
                html += items.map(item => {
                    const action = getActionRequired(item);
                    return `
                        <tr>
                            <td>
                                <div class="ticket-info">
                                    <div class="ticket-main-line">
                                        <strong class="ticket-id">${item.ticketId}</strong>
                                        <span>${toProperCase(item.customer || '')}</span>
                                    </div>
                                    <div class="ticket-customer">
                                        <em>${item.type || 'N/A'}</em>
                                    </div>
                                </div>
                            </td>
                            <td>${item.orderReceived}</td>
                            <td>${item.urgent === 'Yes' ? '<span class="badge badge-urgent">URGENT</span>' : 'No'}</td>
                            <td>${getAgingBadge(item.aging)}</td>
                            <td><div class="action-btn ${action.class}">${action.text}</div></td>
                        </tr>
                    `;
                }).join('');
            }

            tbody.innerHTML = html;
        }
        
        function renderLocationSummary(data) {
            const summaryContainer = document.getElementById('locationSummaryContent');
            if (!data || data.length === 0) {
                summaryContainer.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 2rem;">No pending items.</div>';
                return;
            }

            const groupBy = (arr, key) => arr.reduce((acc, item) => {
                const groupKey = item[key] || 'Unassigned';
                (acc[groupKey] = acc[groupKey] || []).push(item);
                return acc;
            }, {});

            const groupedData = groupBy(data, 'loc');
            const sortedLocations = Object.keys(groupedData).sort();

            let summaryHtml = '<table><tbody>';
            for (const location of sortedLocations) {
                const count = groupedData[location].length;
                summaryHtml += `<tr><td>${location}</td><td>${count}</td></tr>`;
            }
            summaryHtml += '</tbody></table>';

            summaryContainer.innerHTML = summaryHtml;
        }

        function renderAgingChart(data) {
            const ctx = document.getElementById('agingChart').getContext('2d');
            const stats = { 'Same Day': 0, '1 Day': 0, '2 Days': 0, '3 Days': 0, '> 3 Days': 0 };

            data.forEach(item => {
                const displayAging = Math.max(0, item.aging - 1);
                if (displayAging === 0) stats['Same Day']++;
                else if (displayAging === 1) stats['1 Day']++;
                else if (displayAging === 2) stats['2 Days']++;
                else if (displayAging === 3) stats['3 Days']++;
                else stats['> 3 Days']++;
            });

            const chartData = {
                labels: Object.keys(stats),
                datasets: [{
                    data: Object.values(stats),
                    backgroundColor: [
                        '#3b82f6', // same-day
                        '#10b981', // success
                        '#f59e0b', // accent
                        '#ef4444', // error
                        '#8b5cf6'  // purple
                    ],
                    borderColor: 'transparent', // Set to transparent
                }]
            };

            if (agingChartInstance) {
                agingChartInstance.data = chartData;
                agingChartInstance.update();
            } else {
                agingChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: chartData,
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false // Legend is removed
                            },
                            title: {
                                display: false
                            },
                            datalabels: {
                                color: '#ffffff',
                                font: {
                                    weight: 'bold'
                                },
                                formatter: (value, ctx) => {
                                    if (value === 0) return '';
                                    const sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = (value / sum * 100).toFixed(0) + '%';
                                    return `${value}\n(${percentage})`;
                                }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }
        }


        function updateReminders(data = deliveryData) {
            const reminderContent = document.getElementById('reminderContent');
            const urgentTickets = data.filter(item => item.urgent && item.urgent.toLowerCase() === 'yes');
            const isNotUrgent = item => !(item.urgent && item.urgent.toLowerCase() === 'yes');
            const overdueTickets = data.filter(item => isNotUrgent(item) && (item.aging - 1) > 3);
            const threeDayTickets = data.filter(item => isNotUrgent(item) && (item.aging - 1) === 3);
            const twoDayTickets = data.filter(item => isNotUrgent(item) && (item.aging - 1) === 2);

            let html = '';

            const createItemList = (items) => {
                return `<ul class="reminder-list">
                            ${items.map(item => `
                                <li class="reminder-item">
                                    <div><strong>${item.ticketId}</strong> - ${toProperCase(item.customer)}</div>
                                    ${getAgingBadge(item.aging)}
                                </li>`).join('')}
                        </ul>`;
            };

            if (urgentTickets.length > 0) {
                html += `<div class="reminder-section">
                             <div class="reminder-title"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M13 10H11V4H13V10ZM13 12H11V14H13V12ZM12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2Z"></path></svg> <span style="color: var(--error);">URGENT - Top Priority</span></div>
                             <ul class="reminder-list">
                                 ${urgentTickets.map(item => `
                                     <li class="reminder-item">
                                         <div><strong>${item.ticketId}</strong> - ${toProperCase(item.customer)}</div>
                                         <span class="badge badge-urgent">URGENT</span>
                                     </li>`).join('')}
                             </ul>
                         </div>`;
            }
            
            if (overdueTickets.length > 0) {
                 html += `<div class="reminder-section">
                              <div class="reminder-title"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2ZM12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM11 15H13V17H11V15ZM11 7H13V13H11V7Z"></path></svg> <span style="color: var(--error);">Overdue Deliveries</span></div>
                              <div class="reminder-remark">Overdue - Immediate Action Required!</div>
                              ${createItemList(overdueTickets)}
                          </div>`;
            }

            if (threeDayTickets.length > 0) {
                 html += `<div class="reminder-section">
                              <div class="reminder-title"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17 3H7C4.79086 3 3 4.79086 3 7V17C3 19.2091 4.79086 21 7 21H17C19.2091 21 21 19.2091 21 17V7C21 4.79086 19.2091 3 17 3ZM19 17C19 18.1046 18.1046 19 17 19H7C5.89543 19 5 18.1046 5 17V7C5 5.89543 5.89543 5 7 5H17C18.1046 5 19 5.89543 19 7V17ZM15 11H9V13H15V11Z"></path></svg> <span style="color: var(--accent);">3-Day Aging Deliveries</span></div>
                              <div class="reminder-remark">Complete Today</div>
                              ${createItemList(threeDayTickets)}
                          </div>`;
            }

            if (twoDayTickets.length > 0) {
                 html += `<div class="reminder-section">
                              <div class="reminder-title"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17 3H7C4.79086 3 3 4.79086 3 7V17C3 19.2091 4.79086 21 7 21H17C19.2091 21 21 19.2091 21 17V7C21 4.79086 19.2091 3 17 3ZM19 17C19 18.1046 18.1046 19 17 19H7C5.89543 19 5 18.1046 5 17V7C5 5.89543 5.89543 5 7 5H17C18.1046 5 19 5.89543 19 7V17ZM15 11H9V13H15V11Z"></path></svg> <span style="color: var(--same-day);">2-Day Aging Deliveries</span></div>
                              <div class="reminder-remark">Plan - Today or Tomorrow</div>
                              ${createItemList(twoDayTickets)}
                          </div>`;
            }

            if (html === '') {
                if (data.length > 0) {
                    html = `<div style="text-align: center; color: var(--success); padding: 2rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22ZM12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20ZM16.0303 8.96967L10.5 14.5L7.96967 12.0303L9.38388 10.6161L10.5 11.702L14.6161 7.55546L16.0303 8.96967Z"></path></svg>
                                <strong>Great job!</strong> No urgent or aged deliveries. Focus on normal delivery schedule.
                            </div>`;
                } else {
                    html = `<div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                                📤 Upload delivery data to see prioritized action items.
                            </div>`;
                }
            }

            reminderContent.innerHTML = html;
        }

        // ================================
        // FILTERING
        // ================================
        function applyFilters() {
            let filtered = deliveryData.filter(item => item.aging !== undefined && item.aging >= 1);

            if (currentFilter === 'urgent') {
                filtered = filtered.filter(item => item.urgent && item.urgent.toLowerCase() === 'yes');
            } else if (currentFilter !== 'all') {
                const displayAging = parseInt(currentFilter);
                if (displayAging === 4) {
                    filtered = filtered.filter(item => (item.aging - 1) > 3);
                } else {
                    filtered = filtered.filter(item => (item.aging - 1) === displayAging);
                }
            }

            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(item => 
                    item.ticketId.toLowerCase().includes(searchTerm) ||
                    (item.customer || '').toLowerCase().includes(searchTerm) ||
                    (item.type || '').toLowerCase().includes(searchTerm)
                );
            }

            filteredData = filtered;
            renderTable(filteredData);
            updateReminders();
        }

        // ================================
        // DATABASE INTEGRATION - UPDATED WITH DUAL DATABASE SUPPORT
        // ================================
        async function loadDataFromDatabase() {
            try {
                showMessage('🔄 Loading latest delivery data...', 'info', 2000);
                initializeDatabase();
                
                const [agingData, analyticsData, metadata] = await Promise.all([
                    supabase.getDeliveryData(), 
                    supabase.query('GET', `${CONFIG.supabase.analyticsTable}?select=*&order=created_at.desc`).catch(() => []), 
                    supabase.getMetadata()
                ]);
                
                if (agingData && agingData.length > 0) {
                    deliveryData = agingData.map(item => ({
                        ticketId: item.ticket_id,
                        orderReceived: item.order_received,
                        type: item.type,
                        urgent: item.urgent,
                        customer: item.customer,
                        aging: item.aging,
                        loc: item.loc
                    }));
                    
                    const analyticsCount = analyticsData ? analyticsData.length : 0;
                    const agingCount = agingData.length;
                    const lastUpdate = metadata.last_update || 'Never';
                    
                    if (analyticsCount > agingCount) {
                        showMessage(`✅ Data loaded - ${agingCount} pending items (${analyticsCount} total records processed, Last update: ${lastUpdate})`, 'success');
                    } else {
                        showMessage(`✅ Data loaded (${agingCount} records, Last update: ${lastUpdate})`, 'success');
                    }
                } else {
                    deliveryData = [];
                    const analyticsCount = analyticsData ? analyticsData.length : 0;
                    const lastUpdate = metadata.last_update || 'Never';
                    
                    if (analyticsCount > 0) {
                        showMessage(`ℹ️ No pending deliveries! All ${analyticsCount} deliveries completed (Last update: ${lastUpdate})`, 'info');
                    } else {
                        showMessage(`ℹ️ No data in database (Last update: ${lastUpdate})`, 'info');
                    }
                }
                
                updateStats();
                applyFilters();
                renderLocationSummary(deliveryData);
                renderAgingChart(deliveryData);
                return true;
            } catch (error) {
                console.error('Error loading data from database:', error);
                showMessage(`❌ Could not load data: ${error.message}`, 'error');
                updateStats();
                applyFilters();
                renderLocationSummary([]);
                renderAgingChart([]);
                return false;
            }
        }

        // Save to both databases
        async function saveDataToDatabase(data) {
            try {
                showMessage('📤 Saving data to both databases...', 'info', 10000);
                initializeDatabase();
                
                await supabase.saveCompleteAnalyticsData(data);
                showMessage('✅ Complete data saved to analytics database', 'success', 2000);
                
                const filteredData = data.filter(item => item.aging >= 1);
                await supabase.saveDeliveryData(filteredData);
                showMessage('✅ Filtered data saved to aging tracker', 'success', 2000);
                
                await supabase.updateMetadata(filteredData.length, data.length);
                
                showMessage('🎉 Data saved to both databases! Refreshing...', 'success');
                setTimeout(loadDataFromDatabase, 1000);
                return true;
            } catch (error) {
                console.error('Error saving data to databases:', error);
                showMessage(`❌ Failed to save data: ${error.message}`, 'error');
                return false;
            }
        }

        // ================================
        // FILE PROCESSING - UPDATED TO INCLUDE ALL RECORDS
        // ================================
        function convertExcelDate(serialNumber) {
            if (!serialNumber || isNaN(serialNumber)) return serialNumber;
            const excelEpoch = new Date(1899, 11, 30);
            const date = new Date(excelEpoch.getTime() + parseInt(serialNumber) * 24 * 60 * 60 * 1000);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        function parseData(jsonData) {
            if (jsonData.length === 0) throw new Error('No data found in file');
            
            const headers = jsonData[0].map(h => String(h).toLowerCase());
            const rows = jsonData.slice(1);
            
            const findColumn = (possibleNames) => possibleNames.reduce((acc, name) => acc !== -1 ? acc : headers.indexOf(name), -1);

            const ticketIdCol = findColumn(['ticket id', 'ticketid', 'ticket']);
            const orderReceivedCol = findColumn(['order received', 'orderreceived', 'date']);
            const typeCol = findColumn(['type', 'service type']);
            const urgentCol = findColumn(['urgent', 'urgent?']);
            const customerCol = findColumn(['customer', 'client']);
            const agingCol = findColumn(['aging']);
            const locCol = findColumn(['loc', 'location']);

            if (ticketIdCol === -1 || agingCol === -1) {
                throw new Error('File must contain "Ticket ID" and "Aging" columns.');
            }

            return rows.map(row => ({
                ticketId: String(row[ticketIdCol] || ''),
                orderReceived: convertExcelDate(row[orderReceivedCol] || ''),
                type: String(row[typeCol] || ''),
                urgent: String(row[urgentCol] || 'No'),
                customer: String(row[customerCol] || ''),
                aging: parseInt(row[agingCol]) || 0,
                loc: String(row[locCol] || 'N/A')
            })).filter(item => item.ticketId && item.aging >= 0);
        }

        async function processFile(file) {
            showMessage('📖 Reading file...', 'info');
            try {
                const fileName = file.name.toLowerCase();
                let jsonData;

                if (fileName.endsWith('.csv')) {
                    const text = await file.text();
                    jsonData = text.split('\n').map(row => row.split(',').map(cell => cell.trim()));
                } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                    const arrayBuffer = await file.arrayBuffer();
                    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false, defval: '' });
                } else {
                    throw new Error('Unsupported file format. Please use .xlsx, .xls, or .csv.');
                }
                
                const data = parseData(jsonData);
                console.log(`📊 Parsed ${data.length} total records (including completed deliveries)`);
                await saveDataToDatabase(data);
                
            } catch (error) {
                console.error('Error processing file:', error);
                showMessage(`❌ Error processing file: ${error.message}`, 'error');
            }
        }

        // ================================
        // EVENT HANDLERS
        // ================================
        function initializeEventHandlers() {
            document.getElementById('adminBtn').addEventListener('click', () => {
                document.getElementById('passwordModal').style.display = 'flex';
                document.getElementById('adminPassword').focus();
            });

            document.getElementById('refreshBtn').addEventListener('click', loadDataFromDatabase);

            document.getElementById('cancelBtn').addEventListener('click', () => {
                document.getElementById('passwordModal').style.display = 'none';
                document.getElementById('adminPassword').value = '';
            });

            document.getElementById('accessBtn').addEventListener('click', () => {
                if (document.getElementById('adminPassword').value === CONFIG.adminPassword) {
                    document.getElementById('passwordModal').style.display = 'none';
                    document.getElementById('adminPassword').value = '';
                    document.getElementById('fileInput').click();
                } else {
                    alert('❌ Incorrect password. Access denied.');
                    document.getElementById('adminPassword').value = '';
                    document.getElementById('adminPassword').focus();
                }
            });

            document.getElementById('fileInput').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) processFile(file);
                e.target.value = ''; // Reset file input
            });

            document.getElementById('searchBox').addEventListener('input', applyFilters);

            document.querySelectorAll('[data-filter]').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('[data-filter]').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.getAttribute('data-filter');
                    applyFilters();
                });
            });

            document.addEventListener('keydown', (event) => {
                const modal = document.getElementById('passwordModal');
                if (modal.style.display === 'flex') {
                    if (event.key === 'Enter') document.getElementById('accessBtn').click();
                    if (event.key === 'Escape') document.getElementById('cancelBtn').click();
                }
            });
        }

        // ================================
        // INITIALIZATION
        // ================================
        async function initialize() {
            initializeEventHandlers();
            
            try {
                initializeDatabase();
                await loadDataFromDatabase();
            } catch (error) {
                 showMessage(`⚠️ <strong>Configuration Required:</strong><br>${error.message}. Please update the CONFIG section in the code.`, 'error', 20000);
                 updateStats();
                 renderTable([]);
                 updateReminders([]);
            }
        }

        // Auto-refresh every 30 seconds
        setInterval(loadDataFromDatabase, 30000);

        // Start the application
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
